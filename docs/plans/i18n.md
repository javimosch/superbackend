# i18n (Mongo-backed) + Admin UI + AI translation + Audit + Encrypted settings (@intranefr/superbackend)

## Goal
Provide a reusable i18n mini-system inside `@intranefr/superbackend` that host apps (e.g. `ref-bauges`, `ref-enbauges`) can use in **middleware mode** and standalone mode.

- Runtime translations are loaded from **MongoDB**.
- Host apps keep baseline locale JSON files (e.g. `en.json`, `fr.json`) and **seed** them on bootstrap.
- Seeding is **non-destructive** and supports **safe updating** for seeded keys that were never edited.
- Admin (basic-auth superadmin) can manage locales/keys/values in a web UI.
- Optional AI translation (OpenRouter) supports preview-then-apply and glossary.
- All mutations are auditable via a generic @intranefr/superbackend audit system.
- Secrets (API keys) are stored in global settings with **encryption at rest**.

## Scope (v1)
### Functional
- Locales: multi-locale by design. Admin can add new locales beyond seeded ones.
- Keys: free-form strings; dot-notation is allowed but not enforced.
- Values: string values that may include:
  - basic templating variables (`{name}` style)
  - HTML
- Fallback:
  - If key missing in requested locale: fallback to default locale.
  - Default locale is configurable via admin UI; optional env override.
- Seeding from JSON:
  - Insert missing keys.
  - Safe update seeded keys that were never edited.
  - Never overwrite keys that exist in Mongo and were edited.
- Server-side rendering:
  - Provide `res.locals.t(key, vars?, opts?)` helper for EJS.
- Client-side:
  - Provide a public bundle endpoint returning all keys for a locale.
- Admin UI:
  - CRUD locales
  - CRUD entries (key+locale+value)
  - AI translation: manual and bulk, preview then apply, editable preview
- Audit:
  - Record seed operations, CRUD changes, AI apply operations.
- Encryption at rest:
  - OpenRouter API key encrypted in DB.
  - (Optional) glossary/prompt templates may also be encrypted.

### Non-goals (v1)
- Per-organization translations (translations are app-global).
- Complex ICU plural rules and advanced messageformat parsing (only basic interpolation).
- CDN-level caching; only in-process cache with TTL is required.

## Data Model
### I18nLocale
- `code` (unique): string
- `name`: string
- `enabled`: boolean
- `isDefault`: boolean
- timestamps

### I18nEntry
Unique by `{ key, locale }`.
- `key`: string (indexed)
- `locale`: string (indexed)
- `value`: string
- `valueFormat`: `text | html`
- `source`: `seed | admin | ai`
- `seeded`: boolean
- `seedHash`: string
- `seedVersion`: string (optional)
- `edited`: boolean
- `editedAt`: date
- `editedBy`: string (basic-auth username)
- timestamps

### AuditEvent
Generic audit log used by multiple features.
- `actorType`: `admin | user | system`
- `actorId`: string (for basic auth: username)
- `action`: string (e.g. `i18n.entry.update`)
- `entityType`: string
- `entityId`: string
- `before`: mixed/json
- `after`: mixed/json
- `meta`: json (ip, user-agent, seed summary, etc.)
- timestamps

## Encryption at rest (Global Settings)
### Requirement
Secrets must be encrypted at rest in Mongo.

### Proposed approach
- Add a new global setting type: `encrypted`.
- Store encrypted payload (JSON string) in `GlobalSetting.value`:
  - `{ alg, keyId, iv, tag, ciphertext }`
- Use AES-256-GCM.
- Encryption key comes from env: `SUPERBACKEND_ENCRYPTION_KEY`.
- Optional rotation via `keyId`.

## Public API
### Bundle
- `GET /api/i18n/bundle?locale=fr`
  - Returns `{ locale, defaultLocale, entries: { [key]: value } }`.

## Server-side helper API
### EJS helper
- `res.locals.t(key, vars?, opts?)`
  - Interpolation syntax: ICU-ish placeholders `{name}`.
  - HTML is allowed and **trusted**. Rendering mode is explicit:
    - default: escaped
    - if `opts.html === true` or entry is `valueFormat=html`: return raw string for `<%- %>` usage.

## Admin API (basic-auth)
- `GET /api/admin/i18n/locales`
- `POST /api/admin/i18n/locales`
- `PUT /api/admin/i18n/locales/:code`
- `GET /api/admin/i18n/entries?locale=fr&search=&missing=`
- `PUT /api/admin/i18n/entries/:id`
- `POST /api/admin/i18n/entries` (create)
- `POST /api/admin/i18n/ai/preview`
- `POST /api/admin/i18n/ai/apply`

## Admin UI pages (basic-auth)
- `/admin/i18n` (translations)
- `/admin/i18n/locales`

## Seeding (host app integration)
### Host app responsibilities
- Keep locale JSON files in repo, e.g. `./locales/en.json`.
- Call `@intranefr/superbackend.i18n.seedFromJsonFiles({ baseDir, locales: ['en','fr'], seedVersion })` on bootstrap.

### Safe update rules
For each `key+locale` from JSON:
- If doc missing: insert (seeded=true, edited=false, seedHash)
- Else if doc.edited === true: skip
- Else if doc.seeded === true and doc.seedHash matches previous seed hash: update (value + seedHash)
- Else: skip

## AI translation
- Provider: OpenRouter.
- Configuration stored in global settings (encrypted):
  - `i18n.ai.openrouter.apiKey`
  - `i18n.ai.model`
  - `i18n.ai.glossary`
  - `i18n.ai.promptTemplate`
- Flow: preview -> manual edits -> apply selected.

## Caching
- In-process cache keyed by `locale` for bundle and SSR helper.
- TTL-based; invalidate on entry mutations.

## Milestones
1. Add models (`I18nLocale`, `I18nEntry`, `AuditEvent`) and indexes.
2. Add encryption helpers + global settings support for `encrypted`.
3. Implement i18n service:
   - locale resolution
   - `t()` helper
   - bundle building + caching
   - JSON seeding helper
4. Implement public + admin API routes.
5. Implement admin pages and basic JS.
6. Implement OpenRouter integration + preview/apply UI.
7. Add audit hooks to all mutation points.

## Acceptance criteria
- Host app can seed JSON without overwriting admin-edited values.
- EJS routes can call `t()` and get fallback behavior.
- `GET /api/i18n/bundle?locale=fr` returns all keys.
- Admin can CRUD locales and entries.
- AI preview produces suggestions; apply writes to DB and emits audit events.
- OpenRouter key stored encrypted at rest.
