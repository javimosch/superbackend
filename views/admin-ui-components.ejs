<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UI Components - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  </head>
  <body class="bg-gray-100">
    <div id="app" class="min-h-screen">
      <div class="bg-white shadow">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
          <div class="flex justify-between items-center">
            <div>
              <h1 class="text-2xl font-bold text-gray-900">UI Components</h1>
              <p class="text-sm text-gray-600 mt-1">Manage projects, UI components, and assignments.</p>
            </div>
          </div>
        </div>
      </div>

      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
        <div v-if="toast.show" class="fixed top-4 right-4 z-50">
          <div :class="['px-4 py-3 rounded shadow text-sm', toast.type === 'error' ? 'bg-red-600 text-white' : 'bg-green-600 text-white']">
            {{ toast.message }}
          </div>
        </div>

        <div class="bg-white rounded-lg shadow p-4">
          <div class="flex items-center justify-between">
            <div>
              <h2 class="font-semibold text-gray-800">Using the system endpoints & SDK</h2>
              <p class="text-xs text-gray-500">Quick reference for public endpoints and the browser SDK.</p>
            </div>
            <button
              @click="toggleHelp"
              class="text-xs px-2 py-1 rounded border border-gray-200 bg-gray-50 hover:bg-gray-100 text-gray-700"
            >
              {{ helpOpen ? 'Hide' : 'Show' }}
            </button>
          </div>

          <div v-if="helpOpen" class="mt-3 space-y-4 text-sm text-gray-700">
            <div>
              <h3 class="font-semibold text-gray-800 mb-1">Public API endpoints</h3>
              <p class="text-xs text-gray-500 mb-2">All paths are relative to this backend base URL.</p>
              <pre class="text-[11px] bg-gray-50 border border-gray-200 rounded p-2 whitespace-pre-wrap break-words"><code>
GET {{ baseUrl }}/api/ui-components/manifest/:projectId
GET {{ baseUrl }}/api/ui-components/component/:code

// Private projects require an API key header
//   x-project-key: YOUR_PROJECT_API_KEY

curl "{{ baseUrl }}/api/ui-components/manifest/prj_yourproject" \
  -H "x-project-key: YOUR_PROJECT_API_KEY"
              </code></pre>
            </div>

            <div>
              <h3 class="font-semibold text-gray-800 mb-1">Browser SDK</h3>
              <p class="text-xs text-gray-500 mb-2">Include the SDK bundle and initialize it with your project.</p>
              <pre class="text-[11px] bg-gray-50 border border-gray-200 rounded p-2 whitespace-pre-wrap break-words"><code>
&lt;script src="{{ baseUrl }}/public/sdk/ui-components.iife.js"&gt;&lt;/script&gt;
&lt;script&gt;
  uiCmp.init({
    projectId: 'prj_yourproject',
    apiKey: 'YOUR_PROJECT_API_KEY', // null for public projects
    apiUrl: '{{ baseUrl }}',
  });

  // Alias also available
  // uiComponents.init(...same config...);
&lt;/script&gt;
              </code></pre>
            </div>

            <div>
              <h3 class="font-semibold text-gray-800 mb-1">Auto-inject snippet (single script tag)</h3>
              <p class="text-xs text-gray-500 mb-2">Paste this anywhere; it uses the SDK host’s origin and avoids duplicate injection.</p>
              <pre class="autoInjectSnippet text-[11px] bg-gray-50 border border-gray-200 rounded p-2 whitespace-pre-wrap break-words"><code>
&lt;script&gt;
(function () {
  // ---- CONFIG ----
  const SCRIPT_SRC = '__ORIGIN__{{ baseUrl }}/public/sdk/ui-components.iife.js';
  const INIT_OPTS = {
    projectId: 'prj_yourproject',
    apiKey: null, // set string for private projects
    apiUrl: '{{ baseUrl }}',
  };

  // ---- GUARDS (idempotent) ----
  if (window.__uiCmpAutoAdded) return;
  window.__uiCmpAutoAdded = true;

  function initUiCmp() {
    if (!window.uiCmp || window.__uiCmpInitialized) return;
    window.__uiCmpInitialized = true;
    window.uiCmp.init(INIT_OPTS);
  }

  // ---- SCRIPT LOADER ----
  if (window.uiCmp) {
    // SDK already loaded
    initUiCmp();
    return;
  }

  // Avoid duplicate &lt;script&gt; injection
  const existing = document.querySelector('script[src="' + SCRIPT_SRC + '"]');
  if (existing) {
    existing.addEventListener('load', initUiCmp, { once: true });
    return;
  }

  const s = document.createElement('script');
  s.src = SCRIPT_SRC;
  s.async = true;
  s.onload = initUiCmp;
  document.head.appendChild(s);
})();
&lt;/script&gt;
              </code></pre>
            </div>

            <div>
              <h3 class="font-semibold text-gray-800 mb-1">Project setup checklist</h3>
              <ul class="list-disc pl-5 space-y-1 text-xs text-gray-700">
                <li>Create a project (public or private) in the Projects panel.</li>
                <li>Create one or more components and assign them to the project.</li>
                <li v-if="selectedProject && !selectedProject.isPublic">For private projects, copy the API key when it is shown (once) after creation or rotation.</li>
                <li>Optionally configure allowed origins on the project.</li>
                <li>Use the manifest endpoint or SDK to render components on your site.</li>
              </ul>
            </div>

            <div>
              <h3 class="font-semibold text-gray-800 mb-1">Troubleshooting</h3>
              <ul class="list-disc pl-5 space-y-1 text-xs text-gray-700">
                <li>401/403 on private projects usually means a missing or invalid <code>x-project-key</code>.</li>
                <li>Check that the project is active and the component is assigned and enabled.</li>
                <li>Verify that the SDK script URL matches this admin base URL ({{ baseUrl }}).</li>
              </ul>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="bg-white rounded-lg shadow p-4 space-y-4">
            <div class="flex items-center justify-between">
              <h2 class="font-semibold text-gray-800">Projects</h2>
              <button @click="refreshAll" class="text-xs px-2 py-1 rounded bg-gray-100 hover:bg-gray-200">Refresh</button>
            </div>

            <div class="space-y-2">
              <input v-model="newProject.name" class="w-full border rounded px-3 py-2 text-sm" placeholder="Project name" />
              <input v-model="newProject.projectId" class="w-full border rounded px-3 py-2 text-sm" placeholder="projectId (optional, prj_...)" />
              <label class="flex items-center gap-2 text-sm">
                <input type="checkbox" v-model="newProject.isPublic" />
                Public
              </label>
              <button @click="createProject" class="w-full bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-2 rounded">Create project</button>
            </div>

            <div class="border-t pt-3">
              <div class="text-xs text-gray-500 mb-2">Select a project:</div>
              <div class="space-y-1 max-h-[420px] overflow-auto">
                <button
                  v-for="p in projects"
                  :key="p.projectId"
                  @click="selectProject(p)"
                  :class="['w-full text-left px-3 py-2 rounded text-sm border', selectedProject && selectedProject.projectId === p.projectId ? 'bg-blue-50 border-blue-300' : 'bg-white border-gray-200 hover:bg-gray-50']"
                >
                  <div class="font-medium text-gray-900">{{ p.name }}</div>
                  <div class="text-xs text-gray-500">{{ p.projectId }} · <span :class="p.isPublic ? 'text-green-600' : 'text-amber-600'">{{ p.isPublic ? 'public' : 'private' }}</span></div>
                </button>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-lg shadow p-4 space-y-4">
            <div class="flex items-center justify-between">
              <h2 class="font-semibold text-gray-800">Components</h2>
            </div>

            <div class="space-y-2">
              <input v-model="componentEditor.code" class="w-full border rounded px-3 py-2 text-sm" placeholder="code (e.g. toast)" />
              <input v-model="componentEditor.name" class="w-full border rounded px-3 py-2 text-sm" placeholder="name" />
              <textarea v-model="componentEditor.html" class="w-full border rounded px-3 py-2 text-sm font-mono" rows="4" placeholder="html"></textarea>
              <textarea v-model="componentEditor.css" class="w-full border rounded px-3 py-2 text-sm font-mono" rows="3" placeholder="css"></textarea>
              <textarea v-model="componentEditor.js" class="w-full border rounded px-3 py-2 text-sm font-mono" rows="6" placeholder="js (return { show(){...} })"></textarea>
              <textarea v-model="componentEditor.usageMarkdown" class="w-full border rounded px-3 py-2 text-sm" rows="3" placeholder="usageMarkdown"></textarea>

              <div class="flex gap-2">
                <button @click="saveComponent" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-2 rounded">Save</button>
                <button @click="clearComponentEditor" class="px-3 py-2 rounded text-sm bg-gray-100 hover:bg-gray-200">Clear</button>
              </div>
            </div>

            <div class="border-t pt-3 space-y-3">
              <div class="flex items-center justify-between">
                <div>
                  <div class="font-semibold text-gray-900">AI Assist</div>
                  <div class="text-xs text-gray-500">Propose edits and apply into editor (manual Save).</div>
                </div>
                <button @click="loadLlmConfig" class="text-xs px-2 py-1 rounded bg-gray-100 hover:bg-gray-200">Reload LLM</button>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                <%- include('partials/llm-provider-model-picker', {
                  providerInputId: 'uiComponentsAiProviderKey',
                  modelInputId: 'uiComponentsAiModel',
                  providerLabel: 'Provider',
                  modelLabel: 'Model',
                  showOpenRouterFetch: true,
                }) %>
              </div>

              <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Prompt</label>
                <textarea v-model="ai.prompt" class="w-full border rounded px-2 py-2 text-sm" rows="3" placeholder="Describe the change you want..."></textarea>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                <div>
                  <label class="block text-xs font-medium text-gray-600 mb-1">Targets</label>
                  <div class="flex flex-wrap gap-3 text-xs text-gray-700">
                    <label class="flex items-center gap-1"><input type="checkbox" v-model="ai.targets.html" /> html</label>
                    <label class="flex items-center gap-1"><input type="checkbox" v-model="ai.targets.css" /> css</label>
                    <label class="flex items-center gap-1"><input type="checkbox" v-model="ai.targets.js" /> js</label>
                    <label class="flex items-center gap-1"><input type="checkbox" v-model="ai.targets.usageMarkdown" /> usage</label>
                  </div>
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 mb-1">Mode</label>
                  <select v-model="ai.mode" class="w-full border rounded px-2 py-2 text-sm">
                    <option value="minimal">minimal</option>
                    <option value="rewrite">rewrite</option>
                  </select>
                </div>
              </div>

              <div class="flex gap-2">
                <button @click="aiPropose" class="flex-1 px-3 py-2 rounded text-sm bg-purple-600 hover:bg-purple-700 text-white" :disabled="aiLoading">
                  {{ aiLoading ? 'Proposing...' : 'Propose' }}
                </button>
                <button @click="aiApply" class="px-3 py-2 rounded text-sm bg-gray-800 hover:bg-gray-900 text-white" :disabled="!aiProposal">
                  Apply
                </button>
              </div>

              <div v-if="aiWarnings.length" class="text-xs bg-amber-50 border border-amber-200 rounded p-2">
                <div class="font-semibold text-amber-900 mb-1">Warnings</div>
                <ul class="list-disc pl-5 space-y-1">
                  <li v-for="(w, idx) in aiWarnings" :key="idx" class="text-amber-900">{{ w }}</li>
                </ul>
              </div>

              <div v-if="aiProposal" class="text-xs bg-gray-50 border border-gray-200 rounded p-2">
                <div class="font-semibold text-gray-700 mb-1">Patch preview</div>
                <pre class="whitespace-pre-wrap break-words text-[11px]">{{ aiProposal.patch }}</pre>
              </div>
            </div>

            <div class="border-t pt-3">
              <div class="text-xs text-gray-500 mb-2">Existing components:</div>
              <div class="space-y-1 max-h-[320px] overflow-auto">
                <button
                  v-for="c in components"
                  :key="c.code"
                  @click="loadComponentIntoEditor(c.code)"
                  class="w-full text-left px-3 py-2 rounded text-sm border border-gray-200 hover:bg-gray-50"
                >
                  <div class="font-medium text-gray-900">{{ c.name }}</div>
                  <div class="text-xs text-gray-500">{{ c.code }} · v{{ c.version || 1 }}</div>
                </button>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-lg shadow p-4 space-y-4">
            <div class="flex items-center justify-between">
              <h2 class="font-semibold text-gray-800">Assignments</h2>
            </div>

            <div v-if="!selectedProject" class="text-sm text-gray-500">
              Select a project to manage enabled components.
            </div>

            <div v-else class="space-y-3">
              <div class="text-sm">
                <div class="font-medium text-gray-900">{{ selectedProject.name }}</div>
                <div class="text-xs text-gray-500">{{ selectedProject.projectId }}</div>
              </div>

              <div class="space-y-2">
                <label class="flex items-center gap-2 text-sm">
                  <input type="checkbox" v-model="selectedProject.isPublic" @change="toggleProjectPublic" />
                  Public
                </label>

                <button v-if="!selectedProject.isPublic" @click="rotateKey" class="w-full text-sm px-3 py-2 rounded bg-amber-600 hover:bg-amber-700 text-white">
                  Rotate API Key
                </button>

                <div v-if="lastGeneratedKey" class="text-xs bg-gray-50 border border-gray-200 rounded p-2 break-all">
                  <div class="font-semibold text-gray-700 mb-1">API Key (shown once)</div>
                  <div class="font-mono">{{ lastGeneratedKey }}</div>
                </div>

                <div class="text-xs bg-gray-50 border border-gray-200 rounded p-2">
                  <div class="font-semibold text-gray-700 mb-1">Integration snippet</div>
                  <pre class="text-[11px] whitespace-pre-wrap">&lt;script src=&quot;{{ baseUrl }}/public/sdk/ui-components.iife.js&quot;&gt;&lt;/script&gt;
&lt;script&gt;
  uiCmp.init({ projectId: '{{ selectedProject.projectId }}', apiKey: {{ selectedProject.isPublic ? 'null' : "'YOUR_KEY'" }}, apiUrl: '{{ baseUrl }}' });
&lt;/script&gt;</pre>
                </div>
              </div>

              <div class="border-t pt-3">
                <div class="text-xs text-gray-500 mb-2">Enable components:</div>
                <div class="space-y-2 max-h-[360px] overflow-auto">
                  <label v-for="c in components" :key="c.code" class="flex items-center justify-between gap-3 text-sm border border-gray-200 rounded px-3 py-2">
                    <div>
                      <div class="font-medium text-gray-900">{{ c.name }}</div>
                      <div class="text-xs text-gray-500">{{ c.code }}</div>
                    </div>
                    <input type="checkbox" :checked="isAssigned(c.code)" @change="(e) => toggleAssignment(c.code, e.target.checked)" />
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const { createApp, ref, onMounted } = Vue;

      createApp({
        setup() {
          const baseUrl = '<%= baseUrl %>';
          const adminPath = '<%= adminPath %>';
          const API_BASE = window.location.origin + baseUrl;

          const STORAGE_KEYS = {
            providerKey: 'uiComponents.ai.providerKey',
            model: 'uiComponents.ai.model',
            helpOpen: 'uiComponents.help.open',
          };

          const toast = ref({ show: false, message: '', type: 'success' });
          let toastTimer = null;

          function showToast(message, type) {
            toast.value = { show: true, message, type: type || 'success' };
            if (toastTimer) clearTimeout(toastTimer);
            toastTimer = setTimeout(() => {
              toast.value.show = false;
            }, 2500);
          }

          async function api(path, options) {
            const res = await fetch(baseUrl + path, {
              method: (options && options.method) || 'GET',
              headers: {
                'Content-Type': 'application/json',
              },
              body: options && options.body ? JSON.stringify(options.body) : undefined,
            });

            const text = await res.text();
            let data = null;
            try { data = text ? JSON.parse(text) : null; } catch { data = null; }

            if (!res.ok) {
              const msg = (data && data.error) ? data.error : ('Request failed: ' + res.status);
              throw new Error(msg);
            }

            return data;
          }

          const helpOpen = ref(false);

          const projects = ref([]);
          const components = ref([]);
          const selectedProject = ref(null);
          const assignments = ref([]);
          const lastGeneratedKey = ref('');

          const ai = ref({
            providerKey: localStorage.getItem(STORAGE_KEYS.providerKey) || '',
            model: localStorage.getItem(STORAGE_KEYS.model) || '',
            prompt: '',
            mode: 'minimal',
            targets: { html: true, css: true, js: true, usageMarkdown: true },
          });
          const aiLoading = ref(false);
          const aiProposal = ref(null);
          const aiWarnings = ref([]);

          const newProject = ref({ name: '', projectId: '', isPublic: true });

          const componentEditor = ref({ code: '', name: '', html: '', js: '', css: '', usageMarkdown: '' });

          function loadHelpState() {
            try {
              const raw = localStorage.getItem(STORAGE_KEYS.helpOpen);
              if (raw === '1') helpOpen.value = true;
              if (raw === '0') helpOpen.value = false;
            } catch {}
          }

          function persistHelpState() {
            try {
              localStorage.setItem(STORAGE_KEYS.helpOpen, helpOpen.value ? '1' : '0');
            } catch {}
          }

          function toggleHelp() {
            helpOpen.value = !helpOpen.value;
            persistHelpState();
          }

          function syncAiPickerToVue() {
            const providerEl = document.getElementById('uiComponentsAiProviderKey');
            const modelEl = document.getElementById('uiComponentsAiModel');
            if (providerEl) providerEl.value = String(ai.value.providerKey || '');
            if (modelEl) modelEl.value = String(ai.value.model || '');
          }

          function wireAiPickerListeners() {
            const providerEl = document.getElementById('uiComponentsAiProviderKey');
            const modelEl = document.getElementById('uiComponentsAiModel');
            if (!providerEl || !modelEl) return;

            if (providerEl.dataset.wired === '1') return;
            providerEl.dataset.wired = '1';
            modelEl.dataset.wired = '1';

            providerEl.addEventListener('input', () => {
              ai.value.providerKey = String(providerEl.value || '');
              persistAiSettings();
            });
            providerEl.addEventListener('change', () => {
              ai.value.providerKey = String(providerEl.value || '');
              persistAiSettings();
            });

            modelEl.addEventListener('input', () => {
              ai.value.model = String(modelEl.value || '');
              persistAiSettings();
            });
            modelEl.addEventListener('change', () => {
              ai.value.model = String(modelEl.value || '');
              persistAiSettings();
            });
          }

          async function initAiPicker() {
            if (!window.__llmProviderModelPicker || !window.__llmProviderModelPicker.init) return;
            await window.__llmProviderModelPicker.init({
              apiBase: API_BASE,
              providerInputId: 'uiComponentsAiProviderKey',
              modelInputId: 'uiComponentsAiModel',
            });
            syncAiPickerToVue();
            wireAiPickerListeners();
          }

          async function loadLlmConfig() {
            try {
              await initAiPicker();
              showToast('LLM config reloaded', 'success');
            } catch (e) {
              showToast(e.message, 'error');
            }
          }

          function persistAiSettings() {
            try {
              localStorage.setItem(STORAGE_KEYS.providerKey, String(ai.value.providerKey || ''));
              localStorage.setItem(STORAGE_KEYS.model, String(ai.value.model || ''));
            } catch {}
          }

          async function aiPropose() {
            try {
              const code = String(componentEditor.value.code || '').trim().toLowerCase();
              if (!code) throw new Error('Select or enter a component code first');
              const prompt = String(ai.value.prompt || '').trim();
              if (!prompt) throw new Error('Prompt is required');

              persistAiSettings();
              aiLoading.value = true;
              aiProposal.value = null;
              aiWarnings.value = [];

              const payload = {
                prompt,
                providerKey: ai.value.providerKey || undefined,
                model: ai.value.model || undefined,
                targets: ai.value.targets,
                mode: ai.value.mode,
              };

              const data = await api('/api/admin/ui-components/ai/components/' + encodeURIComponent(code) + '/propose', {
                method: 'POST',
                body: payload,
              });

              aiProposal.value = data && data.proposal ? data.proposal : null;
              aiWarnings.value = (aiProposal.value && Array.isArray(aiProposal.value.warnings)) ? aiProposal.value.warnings : [];
              showToast('AI proposal ready', 'success');
            } catch (e) {
              showToast(e.message, 'error');
            } finally {
              aiLoading.value = false;
            }
          }

          function aiApply() {
            try {
              if (!aiProposal.value || !aiProposal.value.fields) return;
              const f = aiProposal.value.fields;
              if (f.html !== undefined) componentEditor.value.html = f.html;
              if (f.css !== undefined) componentEditor.value.css = f.css;
              if (f.js !== undefined) componentEditor.value.js = f.js;
              if (f.usageMarkdown !== undefined) componentEditor.value.usageMarkdown = f.usageMarkdown;
              showToast('Applied proposal into editor (click Save to persist)', 'success');
            } catch (e) {
              showToast(e.message, 'error');
            }
          }

          async function refreshProjects() {
            const data = await api('/api/admin/ui-components/projects');
            projects.value = (data && data.items) ? data.items : [];
          }

          async function refreshComponents() {
            const data = await api('/api/admin/ui-components/components');
            components.value = (data && data.items) ? data.items : [];
          }

          async function refreshAssignments(projectId) {
            const data = await api('/api/admin/ui-components/projects/' + encodeURIComponent(projectId) + '/components');
            assignments.value = (data && data.items) ? data.items : [];
          }

          async function refreshAll() {
            try {
              await Promise.all([refreshProjects(), refreshComponents()]);
              if (selectedProject.value) {
                await refreshAssignments(selectedProject.value.projectId);
              }
              showToast('Refreshed', 'success');
            } catch (e) {
              showToast(e.message, 'error');
            }
          }

          async function createProject() {
            try {
              lastGeneratedKey.value = '';
              const payload = {
                name: newProject.value.name,
                projectId: newProject.value.projectId || undefined,
                isPublic: Boolean(newProject.value.isPublic),
              };
              const data = await api('/api/admin/ui-components/projects', { method: 'POST', body: payload });
              if (data && data.apiKey) lastGeneratedKey.value = data.apiKey;
              newProject.value = { name: '', projectId: '', isPublic: true };
              await refreshProjects();
              showToast('Project created', 'success');
            } catch (e) {
              showToast(e.message, 'error');
            }
          }

          async function selectProject(p) {
            try {
              lastGeneratedKey.value = '';
              selectedProject.value = { ...p };
              await refreshAssignments(p.projectId);
            } catch (e) {
              showToast(e.message, 'error');
            }
          }

          function isAssigned(code) {
            return assignments.value.some((a) => a.componentCode === code && a.enabled);
          }

          async function toggleAssignment(code, enabled) {
            try {
              if (!selectedProject.value) return;
              if (enabled) {
                await api(
                  '/api/admin/ui-components/projects/' + encodeURIComponent(selectedProject.value.projectId) + '/components/' + encodeURIComponent(code),
                  { method: 'POST', body: { enabled: true } },
                );
              } else {
                await api(
                  '/api/admin/ui-components/projects/' + encodeURIComponent(selectedProject.value.projectId) + '/components/' + encodeURIComponent(code),
                  { method: 'DELETE' },
                );
              }
              await refreshAssignments(selectedProject.value.projectId);
              showToast('Updated assignment', 'success');
            } catch (e) {
              showToast(e.message, 'error');
            }
          }

          async function toggleProjectPublic() {
            try {
              lastGeneratedKey.value = '';
              const data = await api('/api/admin/ui-components/projects/' + encodeURIComponent(selectedProject.value.projectId), {
                method: 'PUT',
                body: { isPublic: Boolean(selectedProject.value.isPublic) },
              });
              if (data && data.apiKey) lastGeneratedKey.value = data.apiKey;
              await refreshProjects();
              await refreshAssignments(selectedProject.value.projectId);
              showToast('Project updated', 'success');
            } catch (e) {
              showToast(e.message, 'error');
            }
          }

          async function rotateKey() {
            try {
              lastGeneratedKey.value = '';
              const data = await api('/api/admin/ui-components/projects/' + encodeURIComponent(selectedProject.value.projectId) + '/rotate-key', { method: 'POST' });
              if (data && data.apiKey) lastGeneratedKey.value = data.apiKey;
              showToast('Key rotated', 'success');
            } catch (e) {
              showToast(e.message, 'error');
            }
          }

          function clearComponentEditor() {
            componentEditor.value = { code: '', name: '', html: '', js: '', css: '', usageMarkdown: '' };
          }

          async function loadComponentIntoEditor(code) {
            try {
              const data = await api('/api/admin/ui-components/components/' + encodeURIComponent(code));
              const c = data && data.item ? data.item : null;
              if (!c) return;

              aiProposal.value = null;
              aiWarnings.value = [];

              componentEditor.value = {
                code: c.code || '',
                name: c.name || '',
                html: c.html || '',
                js: c.js || '',
                css: c.css || '',
                usageMarkdown: c.usageMarkdown || '',
              };
            } catch (e) {
              showToast(e.message, 'error');
            }
          }

          async function saveComponent() {
            try {
              const code = String(componentEditor.value.code || '').trim().toLowerCase();
              if (!code) throw new Error('code is required');
              const payload = {
                code,
                name: componentEditor.value.name,
                html: componentEditor.value.html,
                js: componentEditor.value.js,
                css: componentEditor.value.css,
                usageMarkdown: componentEditor.value.usageMarkdown,
              };

              const existing = components.value.find((c) => c.code === code);
              if (existing) {
                await api('/api/admin/ui-components/components/' + encodeURIComponent(code), { method: 'PUT', body: payload });
              } else {
                await api('/api/admin/ui-components/components', { method: 'POST', body: payload });
              }

              await refreshComponents();
              if (selectedProject.value) await refreshAssignments(selectedProject.value.projectId);
              showToast('Component saved', 'success');
            } catch (e) {
              showToast(e.message, 'error');
            }
          }

          onMounted(async () => {
            try {
              loadHelpState();
              await refreshAll();
              await initAiPicker();
            } catch (e) {
              showToast(e.message, 'error');
            }
          });

          return {
            baseUrl,
            adminPath,
            toast,
            helpOpen,
            projects,
            components,
            selectedProject,
            assignments,
            lastGeneratedKey,
            newProject,
            componentEditor,
            toggleHelp,
            ai,
            aiLoading,
            aiProposal,
            aiWarnings,
            refreshAll,
            createProject,
            selectProject,
            isAssigned,
            toggleAssignment,
            toggleProjectPublic,
            rotateKey,
            clearComponentEditor,
            loadComponentIntoEditor,
            saveComponent,
          };
        },
      }).mount('#app');
    </script>
  </body>
</html>
