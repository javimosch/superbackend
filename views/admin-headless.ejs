<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Headless CMS - Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .toast { animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .fade-out { animation: fadeOut 0.3s ease-out forwards; }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body class="bg-gray-100">
  <div class="min-h-screen">
    <div class="bg-white shadow">
      <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">Headless CMS</h1>
            <p class="text-sm text-gray-600 mt-1">Define tables (models), manage data (collections), and issue API tokens</p>
          </div>
          <div class="flex items-center gap-2">
            <button id="btn-refresh" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Refresh</button>
          </div>
        </div>
      </div>
    </div>

    <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <div class="bg-white rounded-lg shadow">
        <div class="border-b border-gray-200">
          <nav class="-mb-px flex gap-6 px-6" aria-label="Tabs">
            <button data-tab="models" class="tab-btn border-transparent text-gray-600 hover:text-gray-800 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Models</button>
            <button data-tab="collections" class="tab-btn border-transparent text-gray-600 hover:text-gray-800 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Collections</button>
            <button data-tab="apis" class="tab-btn border-transparent text-gray-600 hover:text-gray-800 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Collections APIs</button>
          </nav>
        </div>

        <div id="tab-models" class="p-6">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1">
              <div class="flex items-center justify-between mb-3">
                <h2 class="text-lg font-semibold">Models</h2>
                <div class="flex gap-2">
                  <button id="btn-import-external" class="bg-white border px-3 py-2 rounded hover:bg-gray-100 text-sm">Import from Mongo</button>
                  <button id="btn-new-model" class="bg-green-500 text-white px-3 py-2 rounded hover:bg-green-600 text-sm">New</button>
                </div>
              </div>
              <div id="models-list" class="space-y-2">
                <div class="text-gray-500 text-sm">Loading…</div>
              </div>
            </div>

            <div class="lg:col-span-2">
              <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
                <div>
                  <div class="text-sm text-gray-500">Selected model</div>
                  <div id="selected-model-title" class="text-xl font-semibold">None</div>
                </div>
                <div class="flex gap-2">
                  <button id="btn-sync-external" class="bg-white border px-3 py-2 rounded hover:bg-gray-100 text-sm" disabled>Sync/Infer</button>
                  <button id="btn-save-model" class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 text-sm" disabled>Save schema</button>
                  <button id="btn-delete-model" class="bg-red-500 text-white px-3 py-2 rounded hover:bg-red-600 text-sm" disabled>Disable</button>
                </div>
              </div>

              <div class="bg-white border border-gray-200 rounded p-3 mb-4">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                  <div class="text-sm text-gray-600">Mode</div>
                  <div class="flex gap-2">
                    <button id="btn-mode-simple" class="bg-gray-900 text-white px-3 py-2 rounded text-sm" disabled>Simple</button>
                    <button id="btn-mode-advanced" class="bg-white border px-3 py-2 rounded hover:bg-gray-50 text-sm" disabled>Advanced JSON</button>
                    <button id="btn-mode-ai" class="bg-white border px-3 py-2 rounded hover:bg-gray-50 text-sm" disabled>AI assist</button>
                  </div>
                </div>
              </div>

              <div class="grid grid-cols-1 gap-6">
                <div id="panel-simple" class="bg-gray-50 border border-gray-200 rounded p-4">
                  <div class="flex items-center justify-between mb-3">
                    <h3 class="font-semibold">Schema</h3>
                    <button id="btn-add-field" class="bg-gray-900 text-white px-3 py-2 rounded hover:bg-black text-sm" disabled>Add field</button>
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                      <label class="block text-sm font-medium mb-1">Display name</label>
                      <input id="model-displayName" class="border rounded px-3 py-2 w-full" placeholder="e.g. Products" disabled />
                    </div>
                    <div>
                      <label class="block text-sm font-medium mb-1">Code identifier</label>
                      <input id="model-code" class="border rounded px-3 py-2 w-full mono" placeholder="e.g. products" disabled />
                      <div class="text-xs text-gray-500 mt-1" id="model-collection-hint">Stored as Mongo collection <span class="mono">headless_&lt;code&gt;</span></div>
                    </div>
                  </div>

                  <div class="overflow-x-auto">
                    <table class="min-w-full text-sm">
                      <thead>
                        <tr class="text-left text-gray-500 border-b">
                          <th class="py-2 pr-3">Name</th>
                          <th class="py-2 pr-3">Type</th>
                          <th class="py-2 pr-3">Required</th>
                          <th class="py-2 pr-3">Unique</th>
                          <th class="py-2 pr-3">Default</th>
                          <th class="py-2 pr-3">Ref</th>
                          <th class="py-2 pr-3"></th>
                        </tr>
                      </thead>
                      <tbody id="fields-tbody">
                        <tr><td class="py-3 text-gray-500" colspan="7">Select a model</td></tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <div id="panel-advanced" class="bg-gray-50 border border-gray-200 rounded p-4 hidden">
                  <div class="flex items-center justify-between mb-3">
                    <h3 class="font-semibold">Advanced (JSON)</h3>
                    <div class="flex gap-2">
                      <button id="btn-advanced-load" class="bg-white border px-3 py-2 rounded hover:bg-gray-100 text-sm" disabled>Load selected</button>
                      <button id="btn-advanced-validate" class="bg-gray-900 text-white px-3 py-2 rounded hover:bg-black text-sm" disabled>Validate</button>
                      <button id="btn-advanced-save" class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 text-sm" disabled>Save</button>
                    </div>
                  </div>
                  <div class="text-xs text-gray-600 mb-2">Paste a full model definition JSON. Server-owned fields are ignored with warnings.</div>
                  <textarea id="advanced-json" class="w-full h-72 border rounded px-3 py-2 mono text-xs" placeholder='{"codeIdentifier":"posts","displayName":"Posts","fields":[],"indexes":[]}'></textarea>
                  <div id="advanced-result" class="mt-3 hidden">
                    <div class="text-xs text-gray-600 mb-1">Validation</div>
                    <pre id="advanced-result-pre" class="mono text-xs bg-white border rounded p-3 overflow-x-auto"></pre>
                  </div>
                </div>

                <div id="panel-ai" class="bg-gray-50 border border-gray-200 rounded p-4 hidden">
                  <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                      <h3 class="font-semibold">AI assist</h3>
                      <span class="group relative inline-block">
                        <svg class="w-4 h-4 text-gray-400 cursor-help" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
                        </svg>
                        <div class="absolute left-1/2 transform -translate-x-1/2 bottom-full mb-2 hidden group-hover:block z-10 w-80 p-2 bg-gray-900 text-white text-xs rounded shadow-lg">
                          <div class="font-semibold mb-1">Customize AI provider & model</div>
                          <div>Set these GlobalSetting keys (fallback to env vars):</div>
                          <ul class="mt-1 space-y-1">
                            <li><code class="bg-gray-800 px-1 rounded">headless.aiProviderKey</code> (default: openrouter)</li>
                            <li><code class="bg-gray-800 px-1 rounded">headless.aiModel</code> (default: google/gemini-2.5-flash-lite)</li>
                          </ul>
                          <div class="mt-1 text-gray-300">Configure providers in /admin/llm.</div>
                          <div class="absolute left-1/2 transform -translate-x-1/2 top-full mt-1 w-2 h-2 bg-gray-900 rotate-45"></div>
                        </div>
                      </span>
                    </div>
                    <div class="flex gap-2">
                      <button id="btn-ai-clear" class="bg-white border px-3 py-2 rounded hover:bg-gray-100 text-sm" disabled>Clear history</button>
                      <button id="btn-ai-apply" class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 text-sm" disabled>Apply proposal</button>
                    </div>
                  </div>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <div class="text-xs text-gray-600 mb-2">Chat</div>
                      <div id="ai-history" class="bg-white border rounded p-3 h-64 overflow-y-auto text-xs"></div>
                      <div class="mt-2 flex gap-2">
                        <input id="ai-input" class="border rounded px-3 py-2 w-full" placeholder="Describe the models you want, then refine with follow-ups" disabled />
                        <button id="btn-ai-send" class="bg-gray-900 text-white px-3 py-2 rounded hover:bg-black text-sm" disabled>Send</button>
                      </div>
                    </div>
                    <div>
                      <div class="text-xs text-gray-600 mb-2">Latest proposal</div>
                      <pre id="ai-proposal" class="mono text-xs bg-white border rounded p-3 h-64 overflow-x-auto overflow-y-auto"></pre>
                      <div class="text-xs text-gray-500 mt-2">Use “Apply proposal” to execute best-effort creates/updates.</div>
                    </div>
                  </div>
                </div>

              </div>

            </div>
          </div>
        </div>

        <div id="tab-collections" class="p-6 hidden">
          <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <div class="lg:col-span-1">
              <div class="flex items-center justify-between mb-3">
                <h2 class="text-lg font-semibold">Collections</h2>
                <button id="btn-data-refresh-models" class="bg-white border px-3 py-2 rounded hover:bg-gray-100 text-sm">Refresh</button>
              </div>
              <div id="data-models-list" class="space-y-2">
                <div class="text-gray-500 text-sm">Loading…</div>
              </div>
            </div>

            <div class="lg:col-span-3">
              <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-4">
                <div>
                  <div class="text-sm text-gray-500">Selected collection</div>
                  <div id="data-selected-title" class="text-xl font-semibold">None</div>
                </div>

                <div class="flex flex-col md:flex-row gap-2 md:items-end">
                  <div>
                    <label class="block text-xs text-gray-500 mb-1">Filter (Mongo JSON)</label>
                    <input id="data-filter" class="border rounded px-3 py-2 w-80 mono" placeholder='{"field":"value"}' />
                  </div>
                  <div class="flex gap-2">
                    <button id="btn-data-apply" class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 text-sm" disabled>Apply</button>
                    <button id="btn-data-clear" class="bg-white border px-3 py-2 rounded hover:bg-gray-100 text-sm" disabled>Clear</button>
                    <button id="btn-data-new-row" class="bg-green-500 text-white px-3 py-2 rounded hover:bg-green-600 text-sm" disabled>New row</button>
                  </div>
                </div>
              </div>

              <div class="flex items-center justify-between mb-3">
                <div class="text-sm text-gray-600" id="data-meta">&nbsp;</div>
                <div class="flex items-center gap-2">
                  <button id="btn-page-prev" class="bg-white border px-3 py-2 rounded hover:bg-gray-100 text-sm" disabled>Prev</button>
                  <button id="btn-page-next" class="bg-white border px-3 py-2 rounded hover:bg-gray-100 text-sm" disabled>Next</button>
                </div>
              </div>

              <div id="data-table" class="overflow-x-auto text-sm text-gray-600 bg-gray-50 border border-gray-200 rounded p-4">
                <div class="py-6 text-center text-gray-500">Select a collection</div>
              </div>
            </div>
          </div>
        </div>

        <div id="tab-apis" class="p-6 hidden">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-gray-50 border border-gray-200 rounded p-4">
              <div class="flex items-center justify-between mb-3">
                <h2 class="text-lg font-semibold">API tokens</h2>
                <button id="btn-new-token" class="bg-green-500 text-white px-3 py-2 rounded hover:bg-green-600 text-sm">New</button>
              </div>
              <div id="tokens-list" class="space-y-2">
                <div class="text-gray-500 text-sm">Loading…</div>
              </div>
            </div>

            <div class="bg-gray-50 border border-gray-200 rounded p-4">
              <div class="flex items-center justify-between mb-3">
                <h2 class="text-lg font-semibold">cURL examples</h2>
                <div class="text-xs text-gray-500" id="curl-selected-token"></div>
              </div>
              <div class="text-sm text-gray-600 mb-4">Use <span class="mono">Authorization: Bearer</span> or <span class="mono">X-API-Token</span>:</div>
              <div class="space-y-4" id="curl-blocks">
                <!-- List -->
                <div class="bg-white border rounded p-3">
                  <div class="flex items-center justify-between mb-2">
                    <div class="font-medium text-sm">List</div>
                    <button type="button" class="btn-copy-curl text-gray-500 hover:text-gray-800" data-op="list" title="Copy command">
                      <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                      </svg>
                    </button>
                  </div>
                  <pre class="mono text-xs overflow-x-auto" id="curl-list"></pre>
                </div>
                <!-- Create -->
                <div class="bg-white border rounded p-3">
                  <div class="flex items-center justify-between mb-2">
                    <div class="font-medium text-sm">Create</div>
                    <button type="button" class="btn-copy-curl text-gray-500 hover:text-gray-800" data-op="create" title="Copy command">
                      <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                      </svg>
                    </button>
                  </div>
                  <pre class="mono text-xs overflow-x-auto" id="curl-create"></pre>
                </div>
                <!-- Update -->
                <div class="bg-white border rounded p-3">
                  <div class="flex items-center justify-between mb-2">
                    <div class="font-medium text-sm">Update</div>
                    <button type="button" class="btn-copy-curl text-gray-500 hover:text-gray-800" data-op="update" title="Copy command">
                      <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                      </svg>
                    </button>
                  </div>
                  <pre class="mono text-xs overflow-x-auto" id="curl-update"></pre>
                </div>
                <!-- Delete -->
                <div class="bg-white border rounded p-3">
                  <div class="flex items-center justify-between mb-2">
                    <div class="font-medium text-sm">Delete</div>
                    <button type="button" class="btn-copy-curl text-gray-500 hover:text-gray-800" data-op="delete" title="Copy command">
                      <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                      </svg>
                    </button>
                  </div>
                  <pre class="mono text-xs overflow-x-auto" id="curl-delete"></pre>
                </div>
              </div>
            </div>
          </div>

          <div class="mt-6 bg-white border border-gray-200 rounded p-4">
            <div class="flex items-center justify-between mb-2">
              <h3 class="font-semibold">Test request</h3>
              <div class="text-xs text-gray-500">Executes real <span class="mono">/api/headless/*</span> endpoints via admin proxy and logs an audit event</div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium mb-1">Operation</label>
                <select id="api-test-op" class="border rounded px-3 py-2 w-full">
                  <option value="list">List</option>
                  <option value="create">Create</option>
                  <option value="update">Update</option>
                  <option value="delete">Delete</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Model</label>
                <select id="api-test-model" class="border rounded px-3 py-2 w-full"></select>
                <div class="text-xs text-gray-500 mt-1">Uses the selected collection model</div>
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">API token</label>
                <input id="api-test-token" class="border rounded px-3 py-2 w-full mono" placeholder="paste API token" />
                <div class="text-xs text-gray-500 mt-1">Not stored server-side. Cached token can be used if available.</div>
              </div>
            </div>

            <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4" id="api-test-pathvars">
              <div>
                <label class="block text-sm font-medium mb-1">ID (for update/delete)</label>
                <input id="api-test-id" class="border rounded px-3 py-2 w-full mono" placeholder="row id" />
              </div>
            </div>

            <div class="mt-4">
              <div class="font-medium text-sm mb-2">Query parameters</div>
              <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                <div>
                  <label class="block text-xs font-medium mb-1">limit</label>
                  <input id="api-test-limit" type="number" class="border rounded px-3 py-2 w-full" placeholder="10" />
                </div>
                <div>
                  <label class="block text-xs font-medium mb-1">skip</label>
                  <input id="api-test-skip" type="number" class="border rounded px-3 py-2 w-full" placeholder="0" />
                </div>
                <div class="md:col-span-2">
                  <label class="block text-xs font-medium mb-1">populate</label>
                  <input id="api-test-populate" class="border rounded px-3 py-2 w-full" placeholder="field1,field2" />
                </div>
              </div>

              <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <div class="flex items-center justify-between mb-1">
                    <label class="block text-xs font-medium">filter (builder)</label>
                    <button id="btn-filter-add" class="text-xs text-blue-600 hover:underline" type="button">Add</button>
                  </div>
                  <div id="api-test-filter-rows" class="space-y-2"></div>
                  <div class="text-xs text-gray-500 mt-1">Produces JSON object used as <span class="mono">filter</span> query param.</div>
                </div>
                <div>
                  <div class="flex items-center justify-between mb-1">
                    <label class="block text-xs font-medium">sort (builder)</label>
                    <button id="btn-sort-add" class="text-xs text-blue-600 hover:underline" type="button">Add</button>
                  </div>
                  <div id="api-test-sort-rows" class="space-y-2"></div>
                  <div class="text-xs text-gray-500 mt-1">Values should be <span class="mono">1</span> or <span class="mono">-1</span>.</div>
                </div>
              </div>
            </div>

            <div class="mt-4">
              <div class="flex items-center justify-between mb-2">
                <div class="font-medium text-sm">Body payload</div>
                <div class="text-xs text-gray-500">Generated from selected model fields</div>
              </div>
              <div id="api-test-body-fields" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
              <div class="mt-2 text-xs text-gray-500" id="api-test-body-help"></div>
            </div>

            <div class="mt-4 flex gap-2">
              <button id="btn-api-test-execute" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700" type="button">Execute</button>
              <button id="btn-api-test-clear" class="bg-gray-200 text-gray-900 px-4 py-2 rounded hover:bg-gray-300" type="button">Clear</button>
            </div>

            <div id="api-test-result" class="mt-4 hidden">
              <div class="text-sm text-gray-600 mb-1">Result</div>
              <div class="border rounded p-3 bg-gray-50">
                <div class="text-xs text-gray-600 mb-2" id="api-test-result-meta"></div>
                <pre class="mono text-xs overflow-x-auto" id="api-test-result-body"></pre>
              </div>
            </div>
          </div>

          <div class="mt-6 bg-white border border-gray-200 rounded p-4">
            <h3 class="font-semibold mb-2">Token permissions</h3>
            <div class="text-sm text-gray-600 mb-4">Each token has per-table permissions: create/read/update/delete.</div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-1">Name</label>
                <input id="token-name" class="border rounded px-3 py-2 w-full" placeholder="e.g. Website" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">TTL (seconds, optional)</label>
                <input id="token-ttl" type="number" class="border rounded px-3 py-2 w-full" placeholder="e.g. 3600" />
              </div>
            </div>

            <div class="mt-4">
              <div class="flex items-center justify-between mb-2">
                <div class="text-sm font-medium">Permissions</div>
                <button id="btn-add-permission" class="bg-gray-900 text-white px-3 py-2 rounded hover:bg-black text-sm">Add</button>
              </div>
              <div id="permissions-list" class="space-y-2"></div>
            </div>

            <div class="mt-4 flex gap-2">
              <button id="btn-create-token" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Create token</button>
            </div>

            <div id="created-token" class="mt-4 hidden">
              <div class="text-sm text-gray-600 mb-1">Created token (copy now):</div>
              <div class="mono bg-white border rounded p-3 text-sm" id="created-token-value"></div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <div id="toast-container" class="fixed top-4 right-4 space-y-2 z-50"></div>
  </div>

  <div id="modal-import-external" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl mx-4">
      <div class="px-6 py-4 border-b flex items-center justify-between">
        <div>
          <div class="text-lg font-semibold">Import from Mongo</div>
          <div class="text-xs text-gray-500">Creates an external model with code identifier prefix <span class="mono">ext_</span>. Schema is inferred and read-only.</div>
        </div>
        <button id="btn-import-close" class="text-gray-500 hover:text-gray-800" type="button">Close</button>
      </div>

      <div class="px-6 py-4 space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Mongo collection</label>
            <select id="import-collection" class="border rounded px-3 py-2 w-full"></select>
            <div class="text-xs text-gray-500 mt-1">Lists collections from the connected MongoDB.</div>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Sample size</label>
            <input id="import-sampleSize" type="number" class="border rounded px-3 py-2 w-full" value="200" />
            <div class="text-xs text-gray-500 mt-1">Max 1000.</div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Model code identifier</label>
            <input id="import-code" class="border rounded px-3 py-2 w-full mono" placeholder="ext_users" />
            <div class="text-xs text-gray-500 mt-1">Must start with <span class="mono">ext_</span>.</div>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Display name</label>
            <input id="import-displayName" class="border rounded px-3 py-2 w-full" placeholder="Users" />
          </div>
        </div>

        <div class="flex items-center justify-between">
          <div class="text-sm text-gray-600">Inference preview</div>
          <div class="flex gap-2">
            <button id="btn-import-infer" class="bg-white border px-3 py-2 rounded hover:bg-gray-100 text-sm" type="button">Infer preview</button>
            <button id="btn-import-run" class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 text-sm" type="button">Import</button>
          </div>
        </div>

        <div id="import-preview" class="hidden">
          <pre id="import-preview-pre" class="mono text-xs bg-gray-50 border rounded p-3 overflow-x-auto overflow-y-auto max-h-64"></pre>
        </div>
      </div>
    </div>
  </div>

<script>
  const baseUrl = '<%= baseUrl %>';
  const adminPath = '<%= adminPath %>';

  const TOKEN_CACHE_KEY = 'headlessCmsApiTokenCache';

  let state = {
    activeTab: 'models',
    models: [],
    selectedModel: null,
    modelUi: {
      mode: 'simple',
      advancedJson: '',
      advancedValidation: null,
      aiHistory: [],
      aiLastProposal: null,
    },
    data: { items: [], total: 0 },
    dataUi: {
      selectedModelCode: null,
      limit: 25,
      skip: 0,
      filterRaw: '',
    },
    apiUi: {
      selectedTokenId: null,
      selectedTokenValue: null,
    },
    tokens: [],
    permissionsDraft: [],
  };

  function toast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    const el = document.createElement('div');
    const color = type === 'error' ? 'bg-red-600' : type === 'success' ? 'bg-green-600' : 'bg-gray-900';
    el.className = `toast ${color} text-white px-4 py-2 rounded shadow`;
    el.textContent = message;
    container.appendChild(el);
    setTimeout(() => {
      el.classList.add('fade-out');
      setTimeout(() => el.remove(), 350);
    }, 2500);
  }

  async function advancedLoadSelected() {
    const m = state.selectedModel;
    if (!m) return;
    const def = {
      codeIdentifier: m.codeIdentifier,
      displayName: m.displayName,
      description: m.description || '',
      fields: m.fields || [],
      indexes: m.indexes || [],
    };
    const text = JSON.stringify(def, null, 2);
    state.modelUi.advancedJson = text;
    document.getElementById('advanced-json').value = text;
    state.modelUi.advancedValidation = null;
    renderAdvancedValidation();
    toast('Loaded selected model into JSON editor', 'success');
  }

  async function advancedValidate() {
    try {
      const raw = document.getElementById('advanced-json').value;
      state.modelUi.advancedJson = raw;
      const definition = safeJsonParse(raw);
      if (!definition) {
        toast('Invalid JSON', 'error');
        return;
      }
      const result = await api('/api/admin/headless/models/validate', {
        method: 'POST',
        body: JSON.stringify({ definition }),
      });
      state.modelUi.advancedValidation = result;
      renderAdvancedValidation();
      toast(result.valid ? 'Valid' : 'Invalid', result.valid ? 'success' : 'error');
      return result;
    } catch (e) {
      toast(e.message, 'error');
    }
  }

  function setImportModalOpen(open) {
    const modal = document.getElementById('modal-import-external');
    if (!modal) return;
    modal.classList.toggle('hidden', !open);
    modal.classList.toggle('flex', open);
  }

  function setImportPreview(value) {
    const container = document.getElementById('import-preview');
    const pre = document.getElementById('import-preview-pre');
    if (!container || !pre) return;
    if (!value) {
      container.classList.add('hidden');
      pre.textContent = '';
      return;
    }
    container.classList.remove('hidden');
    pre.textContent = JSON.stringify(value, null, 2);
  }

  function normalizeExtCodeFromCollectionName(collectionName) {
    const base = String(collectionName || '')
      .trim()
      .toLowerCase()
      .replace(/[^a-z0-9_]+/g, '_')
      .replace(/^_+|_+$/g, '');
    const safe = base && /^[a-z][a-z0-9_]*$/.test(base) ? base : 'model';
    return `ext_${safe}`;
  }

  async function loadExternalCollectionsIntoModal() {
    const select = document.getElementById('import-collection');
    if (!select) return;
    select.innerHTML = '';
    const { items } = await api('/api/admin/headless/external/collections');
    const cols = Array.isArray(items) ? items : [];
    cols.forEach((c) => {
      const name = String(c && c.name ? c.name : '').trim();
      if (!name) return;
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      select.appendChild(opt);
    });

    const selected = select.value;
    const codeInput = document.getElementById('import-code');
    const dnInput = document.getElementById('import-displayName');
    if (codeInput && selected) codeInput.value = normalizeExtCodeFromCollectionName(selected);
    if (dnInput && selected) dnInput.value = String(selected).replace(/_/g, ' ');
  }

  async function importInferPreview() {
    const collectionName = document.getElementById('import-collection')?.value;
    const sampleSize = Number(document.getElementById('import-sampleSize')?.value || 200) || 200;
    if (!collectionName) {
      toast('Select a collection', 'error');
      return;
    }
    const res = await api('/api/admin/headless/external/infer', {
      method: 'POST',
      body: JSON.stringify({ collectionName, sampleSize }),
    });
    setImportPreview(res);
  }

  async function importRun() {
    const collectionName = document.getElementById('import-collection')?.value;
    const sampleSize = Number(document.getElementById('import-sampleSize')?.value || 200) || 200;
    const codeIdentifier = String(document.getElementById('import-code')?.value || '').trim();
    const displayName = String(document.getElementById('import-displayName')?.value || '').trim();
    if (!collectionName) {
      toast('Select a collection', 'error');
      return;
    }
    if (!codeIdentifier || !codeIdentifier.startsWith('ext_')) {
      toast('codeIdentifier must start with ext_', 'error');
      return;
    }
    const res = await api('/api/admin/headless/external/import', {
      method: 'POST',
      body: JSON.stringify({ collectionName, codeIdentifier, displayName, sampleSize }),
    });
    toast('Imported', 'success');
    setImportModalOpen(false);
    setImportPreview(null);
    await loadModels();
    if (res && res.item && res.item.codeIdentifier) {
      await selectModel(res.item.codeIdentifier);
    }
  }

  async function syncExternalSelectedModel() {
    const m = state.selectedModel;
    if (!m) return;
    const isExternal = m && (m.sourceType === 'external' || m.isExternal === true);
    if (!isExternal) return;
    const sampleSize = Number(prompt('Sample size for inference (max 1000):', '200') || '200');
    const res = await api(`/api/admin/headless/models/${encodeURIComponent(m.codeIdentifier)}/sync`, {
      method: 'POST',
      body: JSON.stringify({ sampleSize }),
    });
    toast('Synced', 'success');
    await loadModels();
    if (res && res.item && res.item.codeIdentifier) {
      await selectModel(res.item.codeIdentifier);
    }
  }

  async function advancedSave() {
    try {
      const v = await advancedValidate();
      if (!v || !v.valid) return;
      const normalized = v.normalized;
      if (!normalized || !normalized.codeIdentifier) {
        toast('Missing codeIdentifier', 'error');
        return;
      }

      const exists = (state.models || []).some((m) => m.codeIdentifier === normalized.codeIdentifier);

      if (exists) {
        await api(`/api/admin/headless/models/${encodeURIComponent(normalized.codeIdentifier)}`, {
          method: 'PUT',
          body: JSON.stringify(normalized),
        });
        toast('Model updated', 'success');
      } else {
        await api('/api/admin/headless/models', {
          method: 'POST',
          body: JSON.stringify(normalized),
        });
        toast('Model created', 'success');
      }

      await loadModels();
      await selectModel(normalized.codeIdentifier);
      setModelMode('simple');
    } catch (e) {
      toast(e.message, 'error');
    }
  }

  async function aiSend() {
    try {
      const input = document.getElementById('ai-input');
      const msg = String(input.value || '').trim();
      if (!msg) return;

      state.modelUi.aiHistory = Array.isArray(state.modelUi.aiHistory) ? state.modelUi.aiHistory : [];
      state.modelUi.aiHistory.push({ role: 'user', content: msg });
      input.value = '';
      renderAiHistory();

      const currentJson = safeJsonParse(document.getElementById('advanced-json').value);
      const currentDefinition = currentJson || (state.selectedModel ? {
        codeIdentifier: state.selectedModel.codeIdentifier,
        displayName: state.selectedModel.displayName,
        description: state.selectedModel.description || '',
        fields: state.selectedModel.fields || [],
        indexes: state.selectedModel.indexes || [],
      } : null);

      const res = await api('/api/admin/headless/ai/model-builder/chat', {
        method: 'POST',
        body: JSON.stringify({
          message: msg,
          history: state.modelUi.aiHistory,
          currentDefinition,
        }),
      });

      const assistantMessage = res.assistantMessage || '';
      state.modelUi.aiHistory.push({ role: 'assistant', content: assistantMessage });
      renderAiHistory();

      state.modelUi.aiLastProposal = res.proposal || null;
      renderAiProposal();

      if (res.validation && res.validation.valid === false) {
        toast('Proposal has validation errors', 'error');
      } else {
        toast('Proposal ready', 'success');
      }
    } catch (e) {
      toast(e.message, 'error');
    }
  }

  function aiClear() {
    state.modelUi.aiHistory = [];
    state.modelUi.aiLastProposal = null;
    renderAiHistory();
    renderAiProposal();
    toast('History cleared', 'success');
  }

  async function aiApply() {
    try {
      const proposal = state.modelUi.aiLastProposal;
      if (!proposal) {
        toast('No proposal', 'error');
        return;
      }
      const res = await api('/api/admin/headless/models/apply', {
        method: 'POST',
        body: JSON.stringify({
          creates: proposal.creates || [],
          updates: proposal.updates || [],
        }),
      });
      if (res.errors && res.errors.length) {
        toast(`Applied with errors (${res.errors.length})`, 'error');
      } else {
        toast('Applied', 'success');
      }
      await loadModels();
    } catch (e) {
      toast(e.message, 'error');
    }
  }

  function loadTokenCache() {
    try {
      const raw = localStorage.getItem(TOKEN_CACHE_KEY);
      const parsed = raw ? JSON.parse(raw) : {};
      return parsed && typeof parsed === 'object' ? parsed : {};
    } catch {
      return {};
    }
  }

  function saveTokenCache(cache) {
    try {
      localStorage.setItem(TOKEN_CACHE_KEY, JSON.stringify(cache || {}));
    } catch {
      // ignore
    }
  }

  function cacheTokenValue(tokenId, tokenValue) {
    if (!tokenId || !tokenValue) return;
    const cache = loadTokenCache();
    cache[String(tokenId)] = String(tokenValue);
    saveTokenCache(cache);
  }

  function getCachedTokenValue(tokenId) {
    const cache = loadTokenCache();
    return cache[String(tokenId)] || null;
  }

  async function copyToClipboard(text) {
    const value = String(text || '');
    if (!value) return false;
    try {
      await navigator.clipboard.writeText(value);
      return true;
    } catch {
      try {
        const ta = document.createElement('textarea');
        ta.value = value;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        ta.remove();
        return true;
      } catch {
        return false;
      }
    }
  }

  function renderDataModelsList() {
    const list = document.getElementById('data-models-list');
    if (!list) return;
    list.innerHTML = '';

    if (!state.models.length) {
      list.innerHTML = '<div class="text-gray-500 text-sm">No collections yet</div>';
      return;
    }

    state.models.forEach((m) => {
      const btn = document.createElement('button');
      const active = state.dataUi.selectedModelCode === m.codeIdentifier;
      btn.className = `w-full text-left px-3 py-2 rounded border ${active ? 'bg-blue-50 border-blue-200' : 'bg-white border-gray-200 hover:bg-gray-50'}`;
      btn.innerHTML = `<div class="font-medium">${m.displayName}</div><div class="text-xs text-gray-500 mono">${m.codeIdentifier}</div>`;
      btn.addEventListener('click', () => selectDataModel(m.codeIdentifier));
      list.appendChild(btn);
    });
  }

  function setTab(tab) {
    state.activeTab = tab;
    document.getElementById('tab-models').classList.toggle('hidden', tab !== 'models');
    document.getElementById('tab-collections').classList.toggle('hidden', tab !== 'collections');
    document.getElementById('tab-apis').classList.toggle('hidden', tab !== 'apis');

    document.querySelectorAll('.tab-btn').forEach((b) => {
      const isActive = b.dataset.tab === tab;
      b.classList.toggle('border-blue-600', isActive);
      b.classList.toggle('text-blue-700', isActive);
      b.classList.toggle('border-transparent', !isActive);
      b.classList.toggle('text-gray-600', !isActive);
    });

    if (tab === 'apis') {
      renderCurlExamples();
      renderSelectedTokenLabel();
      loadTokens();
      loadModels();
    }

    if (tab === 'collections') {
      loadModels();
      renderDataModelsList();
      renderDataSelectedHeader();
    }
  }

  document.querySelectorAll('.tab-btn').forEach((b) => b.addEventListener('click', () => setTab(b.dataset.tab)));

  async function api(path, opts = {}) {
    const res = await fetch(baseUrl + path, {
      headers: { 'Content-Type': 'application/json' },
      ...opts,
    });
    const json = await res.json().catch(() => ({}));
    if (!res.ok) {
      throw new Error(json.error || `Request failed (${res.status})`);
    }
    return json;
  }

  function renderModelsList() {
    const list = document.getElementById('models-list');
    list.innerHTML = '';

    if (!state.models.length) {
      list.innerHTML = '<div class="text-gray-500 text-sm">No models yet</div>';
      return;
    }

    state.models.forEach((m) => {
      const btn = document.createElement('button');
      const active = state.selectedModel && state.selectedModel.codeIdentifier === m.codeIdentifier;
      const isExternal = m && (m.sourceType === 'external' || m.isExternal === true);
      btn.className = `w-full text-left px-3 py-2 rounded border ${active ? 'bg-blue-50 border-blue-200' : 'bg-white border-gray-200 hover:bg-gray-50'}`;
      const label = isExternal
        ? `<div class="flex items-center justify-between gap-2"><div class="font-medium">${m.displayName}</div><span class="text-[10px] uppercase bg-gray-200 text-gray-800 px-2 py-0.5 rounded">External</span></div>`
        : `<div class="font-medium">${m.displayName}</div>`;
      const sub = isExternal && m.sourceCollectionName
        ? `<div class="text-xs text-gray-500 mono">${m.codeIdentifier} &middot; ${String(m.sourceCollectionName).replace(/</g,'&lt;')}</div>`
        : `<div class="text-xs text-gray-500 mono">${m.codeIdentifier}</div>`;
      btn.innerHTML = `${label}${sub}`;
      btn.addEventListener('click', () => selectModel(m.codeIdentifier));
      list.appendChild(btn);
    });
  }

  function setModelFormEnabled(enabled, isNew = false) {
    document.getElementById('model-displayName').disabled = !enabled;
    document.getElementById('model-code').disabled = !enabled || !isNew;
    document.getElementById('btn-add-field').disabled = !enabled;
    document.getElementById('btn-save-model').disabled = !enabled;
    document.getElementById('btn-delete-model').disabled = !enabled || isNew;
    document.getElementById('btn-sync-external').disabled = true;
    document.getElementById('btn-mode-simple').disabled = !enabled;
    document.getElementById('btn-mode-advanced').disabled = !enabled;
    document.getElementById('btn-mode-ai').disabled = !enabled;

    document.getElementById('btn-advanced-load').disabled = !enabled;
    document.getElementById('btn-advanced-validate').disabled = !enabled;
    document.getElementById('btn-advanced-save').disabled = !enabled;

    document.getElementById('ai-input').disabled = !enabled;
    document.getElementById('btn-ai-send').disabled = !enabled;
    document.getElementById('btn-ai-clear').disabled = !enabled;
    document.getElementById('btn-ai-apply').disabled = !enabled;
    // Data tab controls are managed separately
  }

  function setModelFormEnabledForModel(model) {
    if (!model) {
      setModelFormEnabled(false);
      return;
    }

    const isNew = Boolean(model.__isNew);
    const isExternal = model && (model.sourceType === 'external' || model.isExternal === true);

    setModelFormEnabled(true, isNew);

    if (isExternal) {
      document.getElementById('btn-save-model').disabled = true;
      document.getElementById('btn-add-field').disabled = true;
      document.getElementById('btn-mode-advanced').disabled = true;
      document.getElementById('btn-mode-ai').disabled = true;
      document.getElementById('btn-advanced-load').disabled = true;
      document.getElementById('btn-advanced-validate').disabled = true;
      document.getElementById('btn-advanced-save').disabled = true;
      document.getElementById('ai-input').disabled = true;
      document.getElementById('btn-ai-send').disabled = true;
      document.getElementById('btn-ai-clear').disabled = true;
      document.getElementById('btn-ai-apply').disabled = true;
      document.getElementById('btn-sync-external').disabled = false;
      if (state.modelUi.mode !== 'simple') setModelMode('simple');
    }
  }

  function setModelMode(mode) {
    state.modelUi.mode = mode;
    document.getElementById('panel-simple').classList.toggle('hidden', mode !== 'simple');
    document.getElementById('panel-advanced').classList.toggle('hidden', mode !== 'advanced');
    document.getElementById('panel-ai').classList.toggle('hidden', mode !== 'ai');

    const btnSimple = document.getElementById('btn-mode-simple');
    const btnAdv = document.getElementById('btn-mode-advanced');
    const btnAi = document.getElementById('btn-mode-ai');

    btnSimple.className = mode === 'simple'
      ? 'bg-gray-900 text-white px-3 py-2 rounded text-sm'
      : 'bg-white border px-3 py-2 rounded hover:bg-gray-50 text-sm';
    btnAdv.className = mode === 'advanced'
      ? 'bg-gray-900 text-white px-3 py-2 rounded text-sm'
      : 'bg-white border px-3 py-2 rounded hover:bg-gray-50 text-sm';
    btnAi.className = mode === 'ai'
      ? 'bg-gray-900 text-white px-3 py-2 rounded text-sm'
      : 'bg-white border px-3 py-2 rounded hover:bg-gray-50 text-sm';
  }

  function safeJsonParse(text) {
    try {
      return JSON.parse(String(text || ''));
    } catch {
      return null;
    }
  }

  function renderAdvancedValidation() {
    const container = document.getElementById('advanced-result');
    const pre = document.getElementById('advanced-result-pre');
    const v = state.modelUi.advancedValidation;
    if (!v) {
      container.classList.add('hidden');
      pre.textContent = '';
      return;
    }
    container.classList.remove('hidden');
    pre.textContent = JSON.stringify(v, null, 2);
  }

  function renderAiHistory() {
    const container = document.getElementById('ai-history');
    const history = Array.isArray(state.modelUi.aiHistory) ? state.modelUi.aiHistory : [];
    if (!history.length) {
      container.innerHTML = '<div class="text-gray-500">No messages yet</div>';
      return;
    }
    container.innerHTML = '';
    history.forEach((m) => {
      const role = m.role === 'assistant' ? 'assistant' : 'user';
      const el = document.createElement('div');
      el.className = 'mb-2';
      el.innerHTML = `<div class="text-[10px] uppercase text-gray-500 mb-1">${role}</div><div class="whitespace-pre-wrap">${String(m.content || '').replace(/</g,'&lt;')}</div>`;
      container.appendChild(el);
    });
    container.scrollTop = container.scrollHeight;
  }

  function renderAiProposal() {
    const pre = document.getElementById('ai-proposal');
    const proposal = state.modelUi.aiLastProposal;
    pre.textContent = proposal ? JSON.stringify(proposal, null, 2) : '';
  }

  function renderSelectedModel() {
    const title = document.getElementById('selected-model-title');
    const codeInput = document.getElementById('model-code');
    const nameInput = document.getElementById('model-displayName');
    const hint = document.getElementById('model-collection-hint');

    const m = state.selectedModel;
    if (!m) {
      title.textContent = 'None';
      codeInput.value = '';
      nameInput.value = '';
      if (hint) hint.innerHTML = 'Stored as Mongo collection <span class="mono">headless_&lt;code&gt;</span>';
      setModelFormEnabledForModel(null);
      renderFieldsTable();
      return;
    }

    const isExternal = m && (m.sourceType === 'external' || m.isExternal === true);
    title.textContent = m.displayName;
    codeInput.value = m.codeIdentifier;
    nameInput.value = m.displayName;
    if (hint) {
      if (isExternal && m.sourceCollectionName) {
        hint.innerHTML = `External Mongo collection <span class="mono">${String(m.sourceCollectionName).replace(/</g,'&lt;')}</span>`;
      } else {
        hint.innerHTML = 'Stored as Mongo collection <span class="mono">headless_&lt;code&gt;</span>';
      }
    }

    setModelFormEnabledForModel(m);
    renderFieldsTable();
  }

  function renderFieldsTable() {
    const tbody = document.getElementById('fields-tbody');
    const m = state.selectedModel;

    if (!m) {
      tbody.innerHTML = '<tr><td class="py-3 text-gray-500" colspan="7">Select a table</td></tr>';
      return;
    }

    const fields = Array.isArray(m.fields) ? m.fields : [];
    if (!fields.length) {
      tbody.innerHTML = '<tr><td class="py-3 text-gray-500" colspan="7">No fields yet</td></tr>';
      return;
    }

    tbody.innerHTML = '';

    const isExternal = m && (m.sourceType === 'external' || m.isExternal === true);

    fields.forEach((f, idx) => {
      const tr = document.createElement('tr');
      tr.className = 'border-t';

      const typeOptions = ['string','number','boolean','date','object','array','ref','ref[]'];
      const opts = typeOptions.map((t) => `<option value="${t}" ${String(f.type).toLowerCase()===t?'selected':''}>${t}</option>`).join('');

      tr.innerHTML = `
        <td class="py-2 pr-3"><input class="field-name border rounded px-2 py-1 w-40 mono" value="${f.name || ''}" data-idx="${idx}" ${isExternal ? 'disabled' : ''} /></td>
        <td class="py-2 pr-3"><select class="field-type border rounded px-2 py-1" data-idx="${idx}" ${isExternal ? 'disabled' : ''}>${opts}</select></td>
        <td class="py-2 pr-3"><input type="checkbox" class="field-required" data-idx="${idx}" ${f.required?'checked':''} ${isExternal ? 'disabled' : ''} /></td>
        <td class="py-2 pr-3"><input type="checkbox" class="field-unique" data-idx="${idx}" ${f.unique?'checked':''} ${isExternal ? 'disabled' : ''} /></td>
        <td class="py-2 pr-3"><input class="field-default border rounded px-2 py-1 w-40" value="${f.default===undefined?'':String(f.default)}" data-idx="${idx}" placeholder="(optional)" ${isExternal ? 'disabled' : ''} /></td>
        <td class="py-2 pr-3"><input class="field-ref border rounded px-2 py-1 w-40 mono" value="${f.refModelCode||''}" data-idx="${idx}" placeholder="ref model code" ${isExternal ? 'disabled' : ''} /></td>
        <td class="py-2 pr-3 text-right">${isExternal ? '' : `<button class="btn-remove-field text-red-600 hover:underline" data-idx="${idx}">Remove</button>`}</td>
      `;

      tbody.appendChild(tr);
    });

    if (!isExternal) {
      tbody.querySelectorAll('input,select').forEach((el) => {
        el.addEventListener('change', () => syncFieldsFromUI());
        el.addEventListener('input', () => syncFieldsFromUI());
      });
    }

    if (!isExternal) {
      tbody.querySelectorAll('.btn-remove-field').forEach((btn) => {
        btn.addEventListener('click', () => {
          const idx = Number(btn.dataset.idx);
          const fields = Array.isArray(state.selectedModel.fields) ? state.selectedModel.fields : [];
          fields.splice(idx, 1);
          state.selectedModel.fields = fields;
          renderFieldsTable();
        });
      });
    }

    updateRefVisibility();
  }

  function updateRefVisibility() {
    const tbody = document.getElementById('fields-tbody');
    tbody.querySelectorAll('tr').forEach((tr) => {
      const select = tr.querySelector('.field-type');
      const ref = tr.querySelector('.field-ref');
      if (!select || !ref) return;
      const t = String(select.value).toLowerCase();
      ref.disabled = !(t === 'ref' || t === 'ref[]');
      if (ref.disabled) ref.value = '';
    });
  }

  function syncFieldsFromUI() {
    const m = state.selectedModel;
    if (!m) return;

    m.displayName = document.getElementById('model-displayName').value;

    const rows = Array.from(document.querySelectorAll('#fields-tbody tr'));
    const fields = [];
    rows.forEach((tr) => {
      const name = tr.querySelector('.field-name')?.value?.trim();
      const type = tr.querySelector('.field-type')?.value?.trim();
      const required = tr.querySelector('.field-required')?.checked;
      const unique = tr.querySelector('.field-unique')?.checked;
      const def = tr.querySelector('.field-default')?.value;
      const refModelCode = tr.querySelector('.field-ref')?.value?.trim();
      if (!name) return;

      const field = { name, type, required: !!required, unique: !!unique };
      if (def !== undefined && String(def).trim() !== '') {
        field.default = def;
      }
      const t = String(type).toLowerCase();
      if ((t === 'ref' || t === 'ref[]') && refModelCode) {
        field.refModelCode = refModelCode;
      }
      fields.push(field);
    });

    m.fields = fields;
    updateRefVisibility();
  }

  async function loadModels() {
    try {
      const { items } = await api('/api/admin/headless/models');
      state.models = items || [];
      renderModelsList();
      renderDataModelsList();

      if (state.selectedModel && !state.selectedModel.__isNew) {
        const still = state.models.find((m) => m.codeIdentifier === state.selectedModel.codeIdentifier);
        if (still) {
          state.selectedModel = still;
          renderSelectedModel();
        }
      }
    } catch (e) {
      toast(e.message, 'error');
    }
  }

  async function selectModel(codeIdentifier) {
    const m = state.models.find((x) => x.codeIdentifier === codeIdentifier);
    state.selectedModel = m || null;
    renderSelectedModel();
    renderCurlExamples();

    if (state.selectedModel) {
      state.modelUi.advancedValidation = null;
      renderAdvancedValidation();
      renderAiHistory();
      renderAiProposal();
    }
  }

  function renderDataSelectedHeader() {
    const title = document.getElementById('data-selected-title');
    if (!title) return;

    const code = state.dataUi.selectedModelCode;
    const m = state.models.find((x) => x.codeIdentifier === code);
    title.textContent = m ? m.displayName : 'None';

    const applyBtn = document.getElementById('btn-data-apply');
    const clearBtn = document.getElementById('btn-data-clear');
    const newRowBtn = document.getElementById('btn-data-new-row');
    if (applyBtn) applyBtn.disabled = !m;
    if (clearBtn) clearBtn.disabled = !m;
    if (newRowBtn) newRowBtn.disabled = !m;

    const filterInput = document.getElementById('data-filter');
    if (filterInput) {
      filterInput.disabled = !m;
      if (!m) filterInput.value = '';
      if (m && !filterInput.value && state.dataUi.filterRaw) {
        filterInput.value = state.dataUi.filterRaw;
      }
    }

    renderDataPagination();
  }

  async function selectDataModel(codeIdentifier) {
    state.dataUi.selectedModelCode = codeIdentifier;
    state.dataUi.skip = 0;
    renderDataModelsList();
    renderDataSelectedHeader();
    await loadDataPage();
  }

  async function saveModel() {
    try {
      const m = state.selectedModel;
      if (!m) return;

      if (m && (m.sourceType === 'external' || m.isExternal === true)) {
        toast('External models are read-only. Use Sync/Infer to refresh.', 'error');
        return;
      }

      syncFieldsFromUI();

      const payload = {
        codeIdentifier: document.getElementById('model-code').value.trim(),
        displayName: document.getElementById('model-displayName').value.trim(),
        fields: m.fields || [],
      };

      let res;
      if (m.__isNew) {
        res = await api('/api/admin/headless/models', { method: 'POST', body: JSON.stringify(payload) });
        toast('Model created', 'success');
        state.selectedModel = null;
        await loadModels();
        await selectModel(res.item.codeIdentifier);
      } else {
        res = await api(`/api/admin/headless/models/${encodeURIComponent(m.codeIdentifier)}`, { method: 'PUT', body: JSON.stringify(payload) });
        toast('Schema saved', 'success');
        await loadModels();
        await selectModel(res.item.codeIdentifier);
      }

      return res;
    } catch (e) {
      toast(e.message, 'error');
    }
  }

  async function disableModel() {
    try {
      const m = state.selectedModel;
      if (!m || m.__isNew) return;
      await api(`/api/admin/headless/models/${encodeURIComponent(m.codeIdentifier)}`, { method: 'DELETE' });
      toast('Model disabled', 'success');
      state.selectedModel = null;
      renderSelectedModel();
      await loadModels();
    } catch (e) {
      toast(e.message, 'error');
    }
  }

  async function loadDataPage() {
    const code = state.dataUi.selectedModelCode;
    if (!code) {
      state.data = { items: [], total: 0 };
      renderDataMeta();
      renderDataTable();
      renderDataPagination();
      return;
    }

    let filterObj = null;
    const filterRaw = String(state.dataUi.filterRaw || '').trim();
    if (filterRaw) {
      try {
        filterObj = JSON.parse(filterRaw);
      } catch {
        toast('Invalid filter JSON', 'error');
        return;
      }
    }

    const params = new URLSearchParams();
    params.set('limit', String(state.dataUi.limit));
    params.set('skip', String(state.dataUi.skip));
    if (filterObj) params.set('filter', JSON.stringify(filterObj));

    try {
      const { items, total, limit, skip } = await api(`/api/admin/headless/collections/${encodeURIComponent(code)}?${params.toString()}`);
      state.data = { items: items || [], total: total || 0, limit: limit || state.dataUi.limit, skip: skip || state.dataUi.skip };
      state.dataUi.limit = state.data.limit;
      state.dataUi.skip = state.data.skip;
      renderDataMeta();
      renderDataTable();
      renderDataPagination();
    } catch (e) {
      toast(e.message, 'error');
    }
  }

  function renderDataMeta() {
    const meta = document.getElementById('data-meta');
    if (!meta) return;
    const code = state.dataUi.selectedModelCode;
    if (!code) {
      meta.textContent = '';
      return;
    }

    const total = Number(state.data.total || 0);
    const limit = Number(state.data.limit || state.dataUi.limit);
    const skip = Number(state.data.skip || state.dataUi.skip);
    const from = total === 0 ? 0 : skip + 1;
    const to = Math.min(skip + limit, total);
    meta.textContent = `Showing ${from}-${to} of ${total}`;
  }

  function renderDataPagination() {
    const prev = document.getElementById('btn-page-prev');
    const next = document.getElementById('btn-page-next');
    if (!prev || !next) return;
    const total = Number(state.data.total || 0);
    const limit = Number(state.data.limit || state.dataUi.limit);
    const skip = Number(state.data.skip || state.dataUi.skip);

    prev.disabled = skip <= 0;
    next.disabled = skip + limit >= total;
  }

  function renderDataTable() {
    const container = document.getElementById('data-table');

    const code = state.dataUi.selectedModelCode;
    const m = state.models.find((x) => x.codeIdentifier === code);

    if (!m) {
      container.innerHTML = '<div class="py-6 text-center text-gray-500">Select a collection</div>';
      return;
    }

    const items = state.data.items || [];
    const fields = (m.fields || []).map((f) => f.name).filter((n) => n);
    const cols = ['_id', ...fields];

    if (!items.length) {
      container.innerHTML = '<div class="py-6 text-center text-gray-500">No rows yet</div>';
      return;
    }

    let html = '<table class="min-w-full text-sm"><thead><tr class="text-left text-gray-500 border-b">';
    cols.forEach((c) => { html += `<th class="py-2 pr-3 mono">${c}</th>`; });
    html += '<th class="py-2 pr-3"></th></tr></thead><tbody>';

    items.forEach((it) => {
      html += '<tr class="border-t">';
      cols.forEach((c) => {
        const val = it[c];
        const s = val === undefined ? '' : typeof val === 'object' ? JSON.stringify(val) : String(val);
        const ro = c === '_id' ? 'readonly' : '';
        html += `<td class="py-2 pr-3"><input ${ro} data-id="${it._id}" data-field="${c}" class="cell border rounded px-2 py-1 w-56 mono ${ro?'bg-gray-100':''}" value="${s.replace(/"/g,'&quot;')}" /></td>`;
      });
      html += `<td class="py-2 pr-3 text-right"><button class="btn-del-row text-red-600 hover:underline" data-id="${it._id}">Delete</button></td>`;
      html += '</tr>';
    });

    html += '</tbody></table>';
    container.innerHTML = html;

    container.querySelectorAll('.cell').forEach((inp) => {
      inp.addEventListener('keydown', async (e) => {
        if (e.key !== 'Enter') return;
        e.preventDefault();
        await saveCell(inp);
      });
      inp.addEventListener('blur', async () => {
        if (inp.dataset.field === '_id') return;
        await saveCell(inp);
      });
    });

    container.querySelectorAll('.btn-del-row').forEach((btn) => {
      btn.addEventListener('click', async () => {
        await deleteRow(btn.dataset.id);
      });
    });
  }

  function parseValue(v) {
    const s = String(v ?? '').trim();
    if (!s) return null;
    if (s === 'true') return true;
    if (s === 'false') return false;
    if (!Number.isNaN(Number(s)) && s.match(/^[+-]?(\d+\.?\d*|\d*\.?\d+)$/)) return Number(s);
    try {
      return JSON.parse(s);
    } catch {
      return s;
    }
  }

  async function saveCell(input) {
    const code = state.dataUi.selectedModelCode;
    const m = state.models.find((x) => x.codeIdentifier === code);
    if (!m) return;

    const id = input.dataset.id;
    const field = input.dataset.field;
    if (!id || !field || field === '_id') return;

    const isTemp = String(id || '').startsWith('temp-');

    try {
      const value = parseValue(input.value);

      if (isTemp) {
        const payload = { [field]: value };
        const { item } = await api(`/api/admin/headless/collections/${encodeURIComponent(m.codeIdentifier)}`, {
          method: 'POST',
          body: JSON.stringify(payload),
        });
        const realId = item._id;
        const idx = state.data.items.findIndex((it) => it._id === id);
        if (idx !== -1) {
          state.data.items[idx] = { ...state.data.items[idx], _id: realId, [field]: value };
        }
        toast('Row created', 'success');
        await loadDataPage();
      } else {
        await api(`/api/admin/headless/collections/${encodeURIComponent(m.codeIdentifier)}/${encodeURIComponent(id)}`, {
          method: 'PUT',
          body: JSON.stringify({ [field]: value }),
        });
        toast('Saved', 'success');
        await loadDataPage();
      }
    } catch (e) {
      toast(e.message, 'error');
    }
  }

  function newRow() {
    const code = state.dataUi.selectedModelCode;
    const m = state.models.find((x) => x.codeIdentifier === code);
    if (!m) return;

    const tempId = `temp-${Date.now()}`;
    const fields = (m.fields || []).map((f) => f.name).filter((n) => n);
    const cols = ['_id', ...fields];

    const newRowData = { _id: tempId };
    fields.forEach((f) => {
      const fieldDef = m.fields.find((fd) => fd.name === f);
      if (fieldDef) {
        if (fieldDef.default !== undefined) {
          newRowData[f] = fieldDef.default;
        } else if (fieldDef.type === 'boolean') {
          newRowData[f] = false;
        } else if (fieldDef.type === 'number') {
          newRowData[f] = 0;
        } else if (fieldDef.type === 'date') {
          newRowData[f] = new Date().toISOString().slice(0, 16);
        } else {
          newRowData[f] = '';
        }
      }
    });

    state.data.items = [...(state.data.items || []), newRowData];
    renderDataTable();
  }

  async function deleteRow(id) {
    const code = state.dataUi.selectedModelCode;
    const m = state.models.find((x) => x.codeIdentifier === code);
    if (!m) return;

    const isTemp = String(id || '').startsWith('temp-');
    if (isTemp) {
      const idx = state.data.items.findIndex((it) => it._id === id);
      if (idx !== -1) {
        state.data.items.splice(idx, 1);
        renderDataTable();
      }
      return;
    }

    try {
      await api(`/api/admin/headless/collections/${encodeURIComponent(m.codeIdentifier)}/${encodeURIComponent(id)}`, { method: 'DELETE' });
      toast('Row deleted', 'success');
      await loadDataPage();
    } catch (e) {
      toast(e.message, 'error');
    }
  }

  // API token UI
  function renderTokens() {
    const list = document.getElementById('tokens-list');
    list.innerHTML = '';

    if (!state.tokens.length) {
      list.innerHTML = '<div class="text-gray-500 text-sm">No tokens yet</div>';
      return;
    }

    state.tokens.forEach((t) => {
      const card = document.createElement('button');
      const isSelected = state.apiUi.selectedTokenId === t._id;
      card.type = 'button';
      card.className = `w-full text-left bg-white border rounded p-3 ${isSelected ? 'border-blue-300 bg-blue-50' : 'border-gray-200 hover:bg-gray-50'}`;

      const exp = t.expiresAt ? new Date(t.expiresAt).toISOString() : 'never';
      card.innerHTML = `
        <div class="flex items-center justify-between gap-3">
          <div>
            <div class="font-medium">${t.name}</div>
            <div class="text-xs text-gray-500">expires: <span class="mono">${exp}</span></div>
          </div>
          <div class="flex items-center gap-2">
            <button type="button" class="btn-copy-token bg-white border border-gray-200 rounded px-2 py-2 hover:bg-gray-100" title="Copy token" data-id="${t._id}">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
            </button>
            <button type="button" class="btn-del-token bg-white border border-gray-200 rounded px-2 py-2 hover:bg-gray-100 text-red-600" title="Delete token" data-id="${t._id}" data-name="${(t.name || '').replace(/"/g,'&quot;')}">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>
                <path d="M10 11v6"></path>
                <path d="M14 11v6"></path>
                <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"></path>
              </svg>
            </button>
          </div>
        </div>
      `;

      card.addEventListener('click', async () => {
        const tokenValue = getCachedTokenValue(t._id);
        state.apiUi.selectedTokenId = t._id;
        state.apiUi.selectedTokenValue = tokenValue;

        if (!tokenValue) {
          const provided = window.prompt('Paste this API token to use it in cURL examples (stored in this browser only):');
          if (provided && String(provided).trim()) {
            cacheTokenValue(t._id, String(provided).trim());
            state.apiUi.selectedTokenValue = String(provided).trim();
          }
        }

        renderTokens();
        renderSelectedTokenLabel();
        renderCurlExamples();
      });

      list.appendChild(card);
    });

    list.querySelectorAll('.btn-copy-token').forEach((btn) => {
      btn.addEventListener('click', async (e) => {
        e.preventDefault();
        e.stopPropagation();
        const id = btn.dataset.id;
        let tokenValue = getCachedTokenValue(id);
        if (!tokenValue) {
          const provided = window.prompt('Paste this API token to store it in this browser and copy it:');
          if (provided && String(provided).trim()) {
            tokenValue = String(provided).trim();
            cacheTokenValue(id, tokenValue);
          }
        }
        if (!tokenValue) return;
        const ok = await copyToClipboard(tokenValue);
        toast(ok ? 'Token copied' : 'Failed to copy', ok ? 'success' : 'error');
      });
    });

    list.querySelectorAll('.btn-del-token').forEach((btn) => {
      btn.addEventListener('click', async (e) => {
        e.preventDefault();
        e.stopPropagation();
        const id = btn.dataset.id;
        const name = btn.dataset.name || 'this token';
        const ok = window.confirm(`Delete token "${name}"? This cannot be undone.`);
        if (!ok) return;

        try {
          await api(`/api/admin/headless/tokens/${encodeURIComponent(id)}`, { method: 'DELETE' });
          toast('Token deleted', 'success');
          if (state.apiUi.selectedTokenId === id) {
            state.apiUi.selectedTokenId = null;
            state.apiUi.selectedTokenValue = null;
            renderSelectedTokenLabel();
            renderCurlExamples();
          }
          await loadTokens();
        } catch (e2) {
          toast(e2.message, 'error');
        }
      });
    });
  }

  async function loadTokens() {
    try {
      const { items } = await api('/api/admin/headless/tokens');
      state.tokens = items || [];
      renderTokens();
    } catch (e) {
      toast(e.message, 'error');
    }
  }

  function renderPermissionsDraft() {
    const container = document.getElementById('permissions-list');
    container.innerHTML = '';

    if (!state.permissionsDraft.length) {
      container.innerHTML = '<div class="text-gray-500 text-sm">No permissions yet</div>';
      return;
    }

    state.permissionsDraft.forEach((p, idx) => {
      const el = document.createElement('div');
      el.className = 'bg-white border border-gray-200 rounded p-3';

      const modelOptions = (state.models || []).map((m) => `<option value="${m.codeIdentifier}" ${m.codeIdentifier===p.modelCode?'selected':''}>${m.displayName} (${m.codeIdentifier})</option>`).join('');

      const ops = ['create','read','update','delete'];
      const opsHtml = ops.map((o) => {
        const checked = Array.isArray(p.operations) && p.operations.includes(o);
        return `<label class="inline-flex items-center gap-2 mr-3"><input type="checkbox" data-idx="${idx}" data-op="${o}" class="perm-op" ${checked?'checked':''} /> <span class="text-sm">${o}</span></label>`;
      }).join('');

      el.innerHTML = `
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div class="flex-1">
            <div class="text-xs text-gray-500 mb-1">Model</div>
            <select class="perm-model border rounded px-2 py-2 w-full" data-idx="${idx}">
              <option value="">Select model…</option>
              ${modelOptions}
            </select>
          </div>
          <div class="flex-1">
            <div class="text-xs text-gray-500 mb-1">Operations</div>
            <div>${opsHtml}</div>
          </div>
          <div class="text-right">
            <button class="perm-remove text-red-600 hover:underline" data-idx="${idx}">Remove</button>
          </div>
        </div>
      `;

      container.appendChild(el);
    });

    container.querySelectorAll('.perm-model').forEach((sel) => {
      sel.addEventListener('change', () => {
        const idx = Number(sel.dataset.idx);
        state.permissionsDraft[idx].modelCode = sel.value;
      });
    });

    container.querySelectorAll('.perm-op').forEach((chk) => {
      chk.addEventListener('change', () => {
        const idx = Number(chk.dataset.idx);
        const op = chk.dataset.op;
        const p = state.permissionsDraft[idx];
        p.operations = Array.isArray(p.operations) ? p.operations : [];
        if (chk.checked) {
          if (!p.operations.includes(op)) p.operations.push(op);
        } else {
          p.operations = p.operations.filter((x) => x !== op);
        }
      });
    });

    container.querySelectorAll('.perm-remove').forEach((btn) => {
      btn.addEventListener('click', () => {
        const idx = Number(btn.dataset.idx);
        state.permissionsDraft.splice(idx, 1);
        renderPermissionsDraft();
      });
    });
  }

  function renderCurlExamples() {
    const model = state.selectedModel ? state.selectedModel.codeIdentifier : 'your_model_code';
    const tokenInline = state.apiUi.selectedTokenValue ? state.apiUi.selectedTokenValue : '${API_TOKEN}';

    const commands = {
      list: `curl -s \"${baseUrl}/api/headless/${model}?limit=10&skip=0\" \\\n  -H \"Authorization: Bearer ${tokenInline}\"`,
      create: `curl -s -X POST \"${baseUrl}/api/headless/${model}\" \\\n  -H \"Authorization: Bearer ${tokenInline}\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"name\":\"example\"}'`,
      update: `curl -s -X PUT \"${baseUrl}/api/headless/${model}/\${ID}\" \\\n  -H \"X-API-Token: ${tokenInline}\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"name\":\"changed\"}'`,
      delete: `curl -s -X DELETE \"${baseUrl}/api/headless/${model}/\${ID}\" \\\n  -H \"X-API-Token: ${tokenInline}\"`,
    };

    Object.keys(commands).forEach(op => {
      const el = document.getElementById(`curl-${op}`);
      if (el) el.textContent = commands[op];
    });
  }

  function renderSelectedTokenLabel() {
    const el = document.getElementById('curl-selected-token');
    if (!el) return;
    if (!state.apiUi.selectedTokenId) {
      el.textContent = '';
      return;
    }
    const token = state.apiUi.selectedTokenValue;
    el.textContent = token ? 'token selected' : 'token not stored in this browser';
  }

  async function createToken() {
    try {
      const name = document.getElementById('token-name').value.trim();
      const ttlSeconds = document.getElementById('token-ttl').value;

      const permissions = (state.permissionsDraft || []).filter((p) => p.modelCode);

      const payload = { name, permissions };
      if (ttlSeconds) payload.ttlSeconds = Number(ttlSeconds);

      const { token, item } = await api('/api/admin/headless/tokens', {
        method: 'POST',
        body: JSON.stringify(payload),
      });

      if (item && item._id && token) {
        cacheTokenValue(item._id, token);
        state.apiUi.selectedTokenId = item._id;
        state.apiUi.selectedTokenValue = token;
      }

      document.getElementById('created-token').classList.remove('hidden');
      document.getElementById('created-token-value').textContent = token;
      toast('Token created', 'success');
      await loadTokens();
      renderSelectedTokenLabel();
      renderCurlExamples();
    } catch (e) {
      toast(e.message, 'error');
    }
  }

  // Buttons
  document.getElementById('btn-refresh').addEventListener('click', async () => {
    await loadModels();
    await loadDataPage();
    await loadTokens();
  });

  document.getElementById('btn-import-external').addEventListener('click', async () => {
    try {
      setImportPreview(null);
      setImportModalOpen(true);
      await loadExternalCollectionsIntoModal();
    } catch (e) {
      toast(e.message, 'error');
    }
  });

  document.getElementById('btn-import-close').addEventListener('click', () => {
    setImportModalOpen(false);
  });

  document.getElementById('import-collection').addEventListener('change', (e) => {
    const name = String(e.target.value || '').trim();
    const codeInput = document.getElementById('import-code');
    const dnInput = document.getElementById('import-displayName');
    if (codeInput && name) codeInput.value = normalizeExtCodeFromCollectionName(name);
    if (dnInput && name) dnInput.value = String(name).replace(/_/g, ' ');
  });

  document.getElementById('btn-import-infer').addEventListener('click', async () => {
    try {
      await importInferPreview();
      toast('Inferred', 'success');
    } catch (e) {
      toast(e.message, 'error');
    }
  });

  document.getElementById('btn-import-run').addEventListener('click', async () => {
    try {
      await importRun();
    } catch (e) {
      toast(e.message, 'error');
    }
  });

  document.getElementById('btn-sync-external').addEventListener('click', async () => {
    try {
      await syncExternalSelectedModel();
    } catch (e) {
      toast(e.message, 'error');
    }
  });

  // Copy cURL buttons
  function setupCurlCopyButtons() {
    document.querySelectorAll('.btn-copy-curl').forEach(btn => {
      btn.addEventListener('click', async () => {
        const op = btn.dataset.op;
        const el = document.getElementById(`curl-${op}`);
        if (!el) return;
        const ok = await copyToClipboard(el.textContent);
        toast(ok ? 'cURL copied' : 'Failed to copy', ok ? 'success' : 'error');
      });
    });
  }

  function apiTestSetVisible() {
    const op = document.getElementById('api-test-op').value;
    const needsId = op === 'update' || op === 'delete';
    document.getElementById('api-test-pathvars').classList.toggle('hidden', !needsId);
    const needsBody = op === 'create' || op === 'update';
    document.getElementById('api-test-body-fields').parentElement.classList.toggle('hidden', !needsBody);
  }

  function apiTestRenderModelOptions() {
    const sel = document.getElementById('api-test-model');
    if (!sel) return;
    sel.innerHTML = '';
    (state.models || []).forEach((m) => {
      const opt = document.createElement('option');
      opt.value = m.codeIdentifier;
      opt.textContent = `${m.displayName} (${m.codeIdentifier})`;
      sel.appendChild(opt);
    });
    const preferred = state.selectedModel ? state.selectedModel.codeIdentifier : null;
    if (preferred && (state.models || []).some((m) => m.codeIdentifier === preferred)) {
      sel.value = preferred;
    }
  }

  function apiTestCurrentModel() {
    const code = document.getElementById('api-test-model').value;
    return (state.models || []).find((m) => m.codeIdentifier === code) || null;
  }

  function apiTestFieldInput(field) {
    const type = String(field.type || '').toLowerCase();
    const name = field.name;

    const container = document.createElement('div');
    container.className = 'bg-white border rounded p-3';

    const label = document.createElement('div');
    label.className = 'text-xs font-medium mb-1';
    label.textContent = `${name} (${type}${field.required ? ', required' : ''})`;
    container.appendChild(label);

    const inputId = `api-test-body-${name}`;
    let input;

    if (type === 'boolean') {
      input = document.createElement('input');
      input.type = 'checkbox';
      input.id = inputId;
      input.className = 'border rounded';
    } else if (type === 'number') {
      input = document.createElement('input');
      input.type = 'number';
      input.id = inputId;
      input.className = 'border rounded px-3 py-2 w-full';
    } else if (type === 'date') {
      input = document.createElement('input');
      input.type = 'datetime-local';
      input.id = inputId;
      input.className = 'border rounded px-3 py-2 w-full';
    } else if (type === 'object' || type === 'array' || type === 'ref[]') {
      input = document.createElement('textarea');
      input.id = inputId;
      input.className = 'border rounded px-3 py-2 w-full mono text-xs';
      input.rows = 3;
      if (type === 'object') input.placeholder = '{"key":"value"}';
      if (type === 'array') input.placeholder = '["value1","value2"]';
      if (type === 'ref[]') input.placeholder = '["<id1>","<id2>"]';
    } else {
      input = document.createElement('input');
      input.type = 'text';
      input.id = inputId;
      input.className = 'border rounded px-3 py-2 w-full';
    }

    input.dataset.fieldName = name;
    input.dataset.fieldType = type;
    container.appendChild(input);

    const info = document.createElement('div');
    info.className = 'text-xs text-gray-500 mt-1';
    if (type === 'object' || type === 'array' || type === 'ref[]') {
      info.textContent = `Example schema: ${input.placeholder}`;
    } else if (type === 'ref') {
      info.textContent = 'Provide referenced id as string';
    } else {
      info.textContent = '';
    }
    container.appendChild(info);

    return container;
  }

  function apiTestRenderBodyFields() {
    const wrap = document.getElementById('api-test-body-fields');
    if (!wrap) return;
    wrap.innerHTML = '';
    const model = apiTestCurrentModel();
    const help = document.getElementById('api-test-body-help');

    if (!model) {
      if (help) help.textContent = 'Select a model to generate fields.';
      return;
    }

    const fields = Array.isArray(model.fields) ? model.fields : [];
    if (help) help.textContent = 'Complex fields accept per-field JSON. Empty fields are not sent.';
    fields.forEach((f) => {
      if (!f || !f.name) return;
      wrap.appendChild(apiTestFieldInput(f));
    });
  }

  function apiTestRenderPairs(containerId, kind) {
    const container = document.getElementById(containerId);
    if (!container) return;
    container.innerHTML = '';
    const arr = state.apiTestUi[kind];
    arr.forEach((row, idx) => {
      const el = document.createElement('div');
      el.className = 'grid grid-cols-12 gap-2';
      el.innerHTML = `
        <input class="border rounded px-2 py-1 col-span-5" placeholder="key" data-kind="${kind}" data-idx="${idx}" data-part="key" value="${row.key || ''}" />
        <input class="border rounded px-2 py-1 col-span-5" placeholder="value" data-kind="${kind}" data-idx="${idx}" data-part="value" value="${row.value || ''}" />
        <button class="col-span-2 text-xs text-red-600 hover:underline" type="button" data-kind="${kind}" data-idx="${idx}" data-action="remove">Remove</button>
      `;
      container.appendChild(el);
    });

    container.querySelectorAll('input').forEach((inp) => {
      inp.addEventListener('input', () => {
        const k = inp.dataset.kind;
        const i = Number(inp.dataset.idx);
        const part = inp.dataset.part;
        state.apiTestUi[k][i][part] = inp.value;
      });
    });

    container.querySelectorAll('button[data-action="remove"]').forEach((btn) => {
      btn.addEventListener('click', () => {
        const k = btn.dataset.kind;
        const i = Number(btn.dataset.idx);
        state.apiTestUi[k].splice(i, 1);
        apiTestRenderPairs(containerId, k);
      });
    });
  }

  function apiTestBuildObject(kind) {
    const out = {};
    (state.apiTestUi[kind] || []).forEach((row) => {
      const key = String(row.key || '').trim();
      if (!key) return;
      if (kind === 'sort') {
        const n = Number(row.value);
        if (n === 1 || n === -1) out[key] = n;
        return;
      }

      const raw = row.value;
      const trimmed = String(raw || '').trim();
      if (!trimmed) return;
      if ((trimmed.startsWith('{') && trimmed.endsWith('}')) || (trimmed.startsWith('[') && trimmed.endsWith(']'))) {
        try {
          out[key] = JSON.parse(trimmed);
          return;
        } catch {
          out[key] = trimmed;
          return;
        }
      }
      out[key] = trimmed;
    });
    return out;
  }

  function apiTestCollectBody() {
    const out = {};
    document.querySelectorAll('#api-test-body-fields [data-field-name]').forEach((el) => {
      const name = el.dataset.fieldName;
      const type = el.dataset.fieldType;

      if (el.tagName.toLowerCase() === 'input' && el.type === 'checkbox') {
        if (el.checked) out[name] = true;
        return;
      }

      const value = String(el.value || '').trim();
      if (!value) return;

      if (type === 'number') {
        out[name] = Number(value);
        return;
      }
      if (type === 'date') {
        const dt = new Date(value);
        out[name] = isNaN(dt.getTime()) ? value : dt.toISOString();
        return;
      }
      if (type === 'object' || type === 'array' || type === 'ref[]') {
        const parsed = safeJsonParse(value);
        if (parsed === null) {
          throw new Error(`Invalid JSON for field: ${name}`);
        }
        out[name] = parsed;
        return;
      }
      out[name] = value;
    });
    return out;
  }

  async function apiTestExecute() {
    const op = document.getElementById('api-test-op').value;
    const modelCode = document.getElementById('api-test-model').value;
    const token = document.getElementById('api-test-token').value.trim() || state.apiUi.selectedTokenValue || '';
    const id = document.getElementById('api-test-id').value.trim();

    const query = {
      limit: document.getElementById('api-test-limit').value,
      skip: document.getElementById('api-test-skip').value,
      populate: document.getElementById('api-test-populate').value,
    };
    const filter = apiTestBuildObject('filter');
    const sort = apiTestBuildObject('sort');
    if (Object.keys(filter).length) query.filter = filter;
    if (Object.keys(sort).length) query.sort = sort;

    let body;
    if (op === 'create' || op === 'update') {
      body = apiTestCollectBody();
    }

    const payload = {
      op,
      modelCode,
      pathVars: { id },
      query,
      body,
      auth: { type: 'bearer', token },
    };

    const result = await api('/api/admin/headless/collections-api-test', {
      method: 'POST',
      body: JSON.stringify(payload),
    });

    const box = document.getElementById('api-test-result');
    box.classList.remove('hidden');
    document.getElementById('api-test-result-meta').textContent = `status=${result.status} durationMs=${result.durationMs}${result.bodyTruncated ? ' (audit body truncated)' : ''}`;
    document.getElementById('api-test-result-body').textContent = JSON.stringify(result.body, null, 2);
  }

  function apiTestClear() {
    document.getElementById('api-test-limit').value = '';
    document.getElementById('api-test-skip').value = '';
    document.getElementById('api-test-populate').value = '';
    document.getElementById('api-test-id').value = '';
    document.getElementById('api-test-token').value = '';
    state.apiTestUi.filter = [];
    state.apiTestUi.sort = [];
    apiTestRenderPairs('api-test-filter-rows', 'filter');
    apiTestRenderPairs('api-test-sort-rows', 'sort');
    document.getElementById('api-test-result').classList.add('hidden');
    document.getElementById('api-test-result-meta').textContent = '';
    document.getElementById('api-test-result-body').textContent = '';
    apiTestRenderBodyFields();
  }

  // Init
  setTab('models');
  const originalLoadModels = loadModels;
  loadModels = async function() {
    await originalLoadModels();
    renderDataModelsList();
    renderDataSelectedHeader();
    apiTestRenderModelOptions();
    apiTestRenderBodyFields();
  };
  loadModels();

  // Ensure copy handlers are attached after DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupCurlCopyButtons);
  } else {
    setupCurlCopyButtons();
  }

  state.apiTestUi = { filter: [], sort: [] };

  document.getElementById('api-test-op').addEventListener('change', () => {
    apiTestSetVisible();
    renderCurlExamples();
  });
  document.getElementById('api-test-model').addEventListener('change', () => {
    apiTestRenderBodyFields();
    renderCurlExamples();
  });

  document.getElementById('btn-filter-add').addEventListener('click', () => {
    state.apiTestUi.filter.push({ key: '', value: '' });
    apiTestRenderPairs('api-test-filter-rows', 'filter');
  });
  document.getElementById('btn-sort-add').addEventListener('click', () => {
    state.apiTestUi.sort.push({ key: '', value: '1' });
    apiTestRenderPairs('api-test-sort-rows', 'sort');
  });

  apiTestRenderPairs('api-test-filter-rows', 'filter');
  apiTestRenderPairs('api-test-sort-rows', 'sort');
  apiTestSetVisible();

  document.getElementById('btn-api-test-execute').addEventListener('click', async () => {
    try {
      await apiTestExecute();
      toast('Executed', 'success');
    } catch (e) {
      toast(e.message, 'error');
    }
  });
  document.getElementById('btn-api-test-clear').addEventListener('click', apiTestClear);

  // If apis tab is active on load, ensure tokens are loaded
  if (state.activeTab === 'apis') {
    loadTokens();
  }

  document.getElementById('btn-new-model').addEventListener('click', () => {
    state.selectedModel = {
      __isNew: true,
      codeIdentifier: '',
      displayName: '',
      fields: [],
      permissions: []
    };
    renderSelectedModel();
    document.getElementById('fields-tbody').innerHTML = '<tr><td class="py-3 text-gray-500" colspan="7">No fields yet</td></tr>';
    setModelFormEnabled(true, true);
    setModelMode('simple');
  });

  document.getElementById('btn-add-field').addEventListener('click', () => {
    if (!state.selectedModel) return;
    state.selectedModel.fields = Array.isArray(state.selectedModel.fields) ? state.selectedModel.fields : [];
    state.selectedModel.fields.push({ name: '', type: 'string', required: false, unique: false });
    renderFieldsTable();
  });

  document.getElementById('btn-mode-simple').addEventListener('click', () => setModelMode('simple'));
  document.getElementById('btn-mode-advanced').addEventListener('click', () => setModelMode('advanced'));
  document.getElementById('btn-mode-ai').addEventListener('click', () => setModelMode('ai'));

  document.getElementById('btn-advanced-load').addEventListener('click', advancedLoadSelected);
  document.getElementById('btn-advanced-validate').addEventListener('click', advancedValidate);
  document.getElementById('btn-advanced-save').addEventListener('click', advancedSave);

  document.getElementById('btn-ai-send').addEventListener('click', aiSend);
  document.getElementById('ai-input').addEventListener('keydown', (e) => {
    if (e.key !== 'Enter') return;
    e.preventDefault();
    aiSend();
  });
  document.getElementById('btn-ai-clear').addEventListener('click', aiClear);
  document.getElementById('btn-ai-apply').addEventListener('click', aiApply);

  document.getElementById('btn-save-model').addEventListener('click', saveModel);
  document.getElementById('btn-delete-model').addEventListener('click', disableModel);

  document.getElementById('model-displayName').addEventListener('input', () => {
    if (!state.selectedModel) return;
    state.selectedModel.displayName = document.getElementById('model-displayName').value;
  });

  document.getElementById('model-code').addEventListener('input', () => {
    if (!state.selectedModel) return;
    state.selectedModel.codeIdentifier = document.getElementById('model-code').value;
  });

  document.getElementById('btn-data-refresh-models').addEventListener('click', async () => {
    await loadModels();
    renderDataModelsList();
  });

  document.getElementById('btn-data-apply').addEventListener('click', async () => {
    state.dataUi.filterRaw = document.getElementById('data-filter').value;
    state.dataUi.skip = 0;
    await loadDataPage();
  });

  document.getElementById('btn-data-clear').addEventListener('click', async () => {
    document.getElementById('data-filter').value = '';
    state.dataUi.filterRaw = '';
    state.dataUi.skip = 0;
    await loadDataPage();
  });

  document.getElementById('btn-data-new-row').addEventListener('click', () => newRow());

  document.getElementById('btn-page-prev').addEventListener('click', async () => {
    state.dataUi.skip = Math.max(0, Number(state.dataUi.skip || 0) - Number(state.dataUi.limit || 25));
    await loadDataPage();
  });

  document.getElementById('btn-page-next').addEventListener('click', async () => {
    state.dataUi.skip = Number(state.dataUi.skip || 0) + Number(state.dataUi.limit || 25);
    await loadDataPage();
  });

  document.getElementById('btn-add-permission').addEventListener('click', () => {
    state.permissionsDraft.push({ modelCode: '', operations: ['read'] });
    renderPermissionsDraft();
  });

  document.getElementById('btn-create-token').addEventListener('click', createToken);
  document.getElementById('btn-new-token').addEventListener('click', () => {
    document.getElementById('created-token').classList.add('hidden');
    document.getElementById('created-token-value').textContent = '';
    document.getElementById('token-name').value = '';
    document.getElementById('token-ttl').value = '';
    state.permissionsDraft = [];
    renderPermissionsDraft();
  });

</script>
</body>
</html>
