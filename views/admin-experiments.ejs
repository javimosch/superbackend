<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Experiments</title>
    <link rel="stylesheet" href="<%= baseUrl %><%= adminPath %>/assets/css/styles.css" />
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 16px; }
      .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
      input, select, button { padding: 8px 10px; }
      table { width: 100%; border-collapse: collapse; margin-top: 12px; }
      th, td { border-bottom: 1px solid #e5e7eb; padding: 10px; text-align: left; }
      .muted { color: #6b7280; }
      .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #f3f4f6; }
    </style>
  </head>
  <body>
    <h1>Experiments</h1>

    <div class="row">
      <label>
        orgId
        <input id="orgId" placeholder="(required for RBAC)" style="min-width: 320px" />
      </label>
      <button id="refresh">Refresh</button>
      <span id="status" class="muted"></span>
    </div>

    <table>
      <thead>
        <tr>
          <th>Code</th>
          <th>Status</th>
          <th>Org</th>
          <th>Winner</th>
          <th>Updated</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <script>
      const statusEl = document.getElementById('status');
      const tbody = document.getElementById('tbody');
      const orgIdEl = document.getElementById('orgId');

      function esc(s) {
        return String(s ?? '').replace(/[&<>"']/g, (c) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]));
      }

      async function load() {
        const orgId = orgIdEl.value.trim();
        statusEl.textContent = 'Loading...';
        tbody.innerHTML = '';

        const url = new URL('<%= baseUrl %>/api/admin/experiments', window.location.origin);
        if (orgId) url.searchParams.set('orgId', orgId);

        const res = await fetch(url.toString(), { headers: { 'Content-Type': 'application/json' } });
        const json = await res.json().catch(() => ({}));

        if (!res.ok) {
          statusEl.textContent = `Error: ${json.error || res.status}`;
          return;
        }

        const items = Array.isArray(json.items) ? json.items : [];
        statusEl.textContent = `${items.length} experiments`;

        tbody.innerHTML = items
          .map((e) => {
            const winner = e.winnerVariantKey ? esc(e.winnerVariantKey) : '<span class="muted">-</span>';
            return `
              <tr>
                <td><span class="pill">${esc(e.code)}</span></td>
                <td>${esc(e.status)}</td>
                <td class="muted">${esc(e.organizationId || '')}</td>
                <td>${winner}</td>
                <td class="muted">${esc(e.updatedAt || '')}</td>
              </tr>
            `;
          })
          .join('');
      }

      document.getElementById('refresh').addEventListener('click', () => load());
      load();
    </script>
  </body>
</html>
