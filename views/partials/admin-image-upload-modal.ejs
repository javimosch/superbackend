<div id="image-upload-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4">
    <div class="flex items-center justify-between px-6 py-4 border-b">
      <h3 class="text-lg font-semibold text-gray-900">Upload image</h3>
      <button type="button" id="image-upload-close" class="text-gray-400 hover:text-gray-600">
        <i class="ti ti-x text-xl"></i>
      </button>
    </div>

    <div class="p-6 space-y-4">
      <div class="text-sm text-gray-600">
        Paste an image (<span class="font-mono">Ctrl+V</span>), drop a file, or pick a file.
      </div>

      <div
        id="image-upload-dropzone"
        class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 transition-colors"
      >
        <div class="text-gray-500">
          <i class="ti ti-photo-plus text-4xl mb-2"></i>
          <div class="font-medium">Drop image here</div>
          <div class="text-sm">or</div>
        </div>
        <div class="mt-3">
          <input id="image-upload-file" type="file" accept="image/*" class="hidden" />
          <button type="button" id="image-upload-pick" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
            Pick file
          </button>
        </div>
      </div>

      <div id="image-upload-progress" class="hidden">
        <div class="text-sm text-gray-600 mb-2">Uploading...</div>
        <div class="w-full bg-gray-200 rounded h-2">
          <div id="image-upload-progress-bar" class="bg-blue-500 h-2 rounded" style="width: 20%"></div>
        </div>
      </div>

      <div id="image-upload-result" class="hidden">
        <div class="text-sm text-gray-600 mb-2">Uploaded URL</div>
        <div class="flex gap-2">
          <input id="image-upload-url" type="text" class="flex-1 border rounded px-3 py-2 text-sm" readonly />
          <button type="button" id="image-upload-copy" class="bg-gray-100 text-gray-800 px-3 py-2 rounded hover:bg-gray-200">
            Copy
          </button>
          <button type="button" id="image-upload-use" class="bg-green-500 text-white px-3 py-2 rounded hover:bg-green-600">
            Use
          </button>
        </div>
      </div>

      <div id="image-upload-error" class="hidden text-sm text-red-600"></div>
    </div>
  </div>
</div>

<script>
  (function() {
    const modal = document.getElementById('image-upload-modal');
    const closeBtn = document.getElementById('image-upload-close');
    const dropzone = document.getElementById('image-upload-dropzone');
    const fileInput = document.getElementById('image-upload-file');
    const pickBtn = document.getElementById('image-upload-pick');
    const progress = document.getElementById('image-upload-progress');
    const progressBar = document.getElementById('image-upload-progress-bar');
    const result = document.getElementById('image-upload-result');
    const urlInput = document.getElementById('image-upload-url');
    const copyBtn = document.getElementById('image-upload-copy');
    const useBtn = document.getElementById('image-upload-use');
    const errorBox = document.getElementById('image-upload-error');

    let currentOnSelect = null;
    let currentNamespace = 'blog-images';
    let currentVisibility = 'public';
    let lastUrl = '';

    function show(el) {
      el.classList.remove('hidden');
    }

    function hide(el) {
      el.classList.add('hidden');
    }

    function setError(msg) {
      errorBox.textContent = msg || '';
      if (msg) show(errorBox);
      else hide(errorBox);
    }

    function resetUI() {
      hide(progress);
      hide(result);
      setError('');
      urlInput.value = '';
      lastUrl = '';
      progressBar.style.width = '20%';
    }

    function openModal({ onSelect, namespace, visibility } = {}) {
      currentOnSelect = typeof onSelect === 'function' ? onSelect : null;
      currentNamespace = namespace ? String(namespace) : 'blog-images';
      currentVisibility = visibility ? String(visibility) : 'public';
      resetUI();
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function closeModal() {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      currentOnSelect = null;
    }

    async function uploadFile(file) {
      try {
        resetUI();
        show(progress);
        progressBar.style.width = '35%';

        const form = new FormData();
        form.append('file', file);
        form.append('namespace', currentNamespace);
        form.append('visibility', currentVisibility);

        const res = await fetch('<%= baseUrl %>/api/admin/assets/upload', {
          method: 'POST',
          body: form,
        });

        progressBar.style.width = '80%';

        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          throw new Error(data?.error || 'Upload failed');
        }

        const url = data?.asset?.publicUrl || '';
        if (!url) {
          throw new Error('Upload succeeded but no publicUrl was returned');
        }

        lastUrl = url;
        urlInput.value = url;
        hide(progress);
        show(result);
        progressBar.style.width = '100%';
      } catch (e) {
        hide(progress);
        setError(e?.message ? String(e.message) : 'Upload failed');
      }
    }

    function fileFromClipboardEvent(e) {
      const items = e?.clipboardData?.items;
      if (!items || !items.length) return null;
      for (const item of items) {
        if (item && item.kind === 'file') {
          const f = item.getAsFile();
          if (f && String(f.type || '').startsWith('image/')) return f;
        }
      }
      return null;
    }

    pickBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', () => {
      const file = fileInput.files && fileInput.files[0];
      if (file) uploadFile(file);
      fileInput.value = '';
    });

    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });

    copyBtn.addEventListener('click', async () => {
      try {
        if (!navigator.clipboard?.writeText) throw new Error('Clipboard API not available');
        await navigator.clipboard.writeText(urlInput.value);
      } catch (e) {
        setError(e?.message ? String(e.message) : 'Failed to copy');
      }
    });

    useBtn.addEventListener('click', () => {
      if (currentOnSelect && lastUrl) {
        currentOnSelect(lastUrl);
      }
      closeModal();
    });

    dropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropzone.classList.add('border-blue-400');
    });

    dropzone.addEventListener('dragleave', () => {
      dropzone.classList.remove('border-blue-400');
    });

    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropzone.classList.remove('border-blue-400');
      const file = e.dataTransfer?.files && e.dataTransfer.files[0];
      if (file) uploadFile(file);
    });

    document.addEventListener('paste', (e) => {
      if (modal.classList.contains('hidden')) return;
      const file = fileFromClipboardEvent(e);
      if (file) {
        e.preventDefault();
        uploadFile(file);
      }
    });

    window.openImageUploadModal = openModal;
  })();
</script>
