<div class="min-w-[200px]">
  <label class="block text-xs font-medium text-gray-600 mb-1"><%= providerLabel || 'LLM Provider Key' %></label>
  <input id="<%= providerInputId %>" class="w-full border rounded px-2 py-2 text-sm" placeholder="e.g. openrouter" list="<%= providerInputId %>__datalist" />
  <datalist id="<%= providerInputId %>__datalist"></datalist>
</div>

<div class="min-w-[260px]">
  <div class="flex flex-wrap items-center justify-between gap-2 mb-1">
    <label class="block text-xs font-medium text-gray-600"><%= modelLabel || 'Model' %></label>
    <% if (showOpenRouterFetch !== false) { %>
      <button
        type="button"
        class="px-2 py-1 bg-gray-200 text-gray-800 rounded text-[11px] whitespace-nowrap"
        onclick="window.__llmProviderModelPicker && window.__llmProviderModelPicker.fetchOpenRouterModels && window.__llmProviderModelPicker.fetchOpenRouterModels({ providerInputId: '<%= providerInputId %>', modelInputId: '<%= modelInputId %>' })"
      >
        Fetch OpenRouter models
      </button>
    <% } %>
  </div>
  <input id="<%= modelInputId %>" class="w-full border rounded px-2 py-2 text-sm" placeholder="e.g. google/gemini-2.5-flash-lite" list="<%= modelInputId %>__datalist" />
  <datalist id="<%= modelInputId %>__datalist"></datalist>
</div>

<script>
  (function () {
    if (!window.__llmProviderModelPicker) {
      window.__llmProviderModelPicker = { instances: {} };
    }

    function safeJsonParse(raw, fallback) {
      try {
        return JSON.parse(raw);
      } catch (_) {
        return fallback;
      }
    }

    async function fetchJson(url) {
      const res = await fetch(url);
      const data = await res.json();
      if (!res.ok) {
        throw new Error(data?.error || 'Request failed');
      }
      return data;
    }

    function setDatalistOptions(datalistEl, items) {
      datalistEl.innerHTML = '';
      const uniq = Array.from(new Set((items || []).filter(Boolean)));
      for (const item of uniq) {
        const opt = document.createElement('option');
        opt.value = String(item);
        datalistEl.appendChild(opt);
      }
    }

    function trim(v) {
      return String(v || '').trim();
    }

    function isOpenRouterProvider({ providerKey, providerConfig }) {
      const pk = String(providerKey || '').trim().toLowerCase();
      if (pk === 'openrouter') return true;

      const baseUrl = providerConfig && typeof providerConfig === 'object'
        ? String(providerConfig.baseUrl || providerConfig.baseURL || '').trim().toLowerCase()
        : '';

      return Boolean(baseUrl && baseUrl.includes('openrouter'));
    }

    function getInstanceKey({ providerInputId, modelInputId }) {
      return `${String(providerInputId || '').trim()}::${String(modelInputId || '').trim()}`;
    }

    function getOrCreateInstance(opts) {
      const key = getInstanceKey(opts);
      const existing = window.__llmProviderModelPicker.instances[key];
      if (existing) return existing;

      const inst = {
        apiBase: opts.apiBase,
        providerInputId: opts.providerInputId,
        modelInputId: opts.modelInputId,
        providers: {},
        providerModels: {},
      };

      window.__llmProviderModelPicker.instances[key] = inst;
      return inst;
    }

    async function loadConfig(inst) {
      const data = await fetchJson(`${inst.apiBase}/api/admin/llm/config`);
      inst.providers = data.providers || {};
      inst.providerModels = data.providerModels || {};
      return data;
    }

    function renderProviderOptions(inst) {
      const providerInput = document.getElementById(inst.providerInputId);
      const providerList = document.getElementById(`${inst.providerInputId}__datalist`);
      if (!providerInput || !providerList) return;

      const providerKeys = Object.keys(inst.providers || {}).sort();
      setDatalistOptions(providerList, providerKeys);
    }

    function renderModelOptions(inst) {
      const providerInput = document.getElementById(inst.providerInputId);
      const modelList = document.getElementById(`${inst.modelInputId}__datalist`);
      if (!providerInput || !modelList) return;

      const providerKey = trim(providerInput.value);
      const models = providerKey && inst.providerModels && typeof inst.providerModels === 'object'
        ? inst.providerModels[providerKey]
        : null;

      setDatalistOptions(modelList, Array.isArray(models) ? models : []);
    }

    async function maybeAutoFetchOpenRouterModels(inst) {
      try {
        const providerInput = document.getElementById(inst.providerInputId);
        if (!providerInput) return;

        const providerKey = trim(providerInput.value);
        const providerConfig = inst.providers && typeof inst.providers === 'object' ? inst.providers[providerKey] : null;
        if (!isOpenRouterProvider({ providerKey, providerConfig })) return;

        const existing = inst.providerModels && typeof inst.providerModels === 'object' ? inst.providerModels.openrouter : null;
        if (Array.isArray(existing) && existing.length > 0) return;

        await fetchOpenRouterModels({
          apiBase: inst.apiBase,
          providerInputId: inst.providerInputId,
          modelInputId: inst.modelInputId,
        });
      } catch {
        // ignore
      }
    }

    async function fetchOpenRouterModels(opts) {
      const inst = getOrCreateInstance(opts || {});
      inst.apiBase = (opts && opts.apiBase) || inst.apiBase || window.__llmProviderModelPicker.defaultApiBase || null;
      if (!inst.apiBase) return;

      const data = await fetchJson(`${inst.apiBase}/api/admin/llm/openrouter/models`);
      const models = Array.isArray(data?.models) ? data.models : [];

      inst.providerModels = inst.providerModels && typeof inst.providerModels === 'object' ? inst.providerModels : {};
      inst.providerModels.openrouter = models;
      renderModelOptions(inst);
    }

    async function init(opts) {
      const inst = getOrCreateInstance(opts || {});

      if (opts && opts.apiBase) {
        window.__llmProviderModelPicker.defaultApiBase = opts.apiBase;
      }

      await loadConfig(inst);
      renderProviderOptions(inst);
      renderModelOptions(inst);
      await maybeAutoFetchOpenRouterModels(inst);

      const providerInput = document.getElementById(inst.providerInputId);
      if (providerInput) {
        providerInput.addEventListener('change', async () => {
          renderModelOptions(inst);
          await maybeAutoFetchOpenRouterModels(inst);
        });
        providerInput.addEventListener('input', () => renderModelOptions(inst));
      }
    }

    window.__llmProviderModelPicker.init = init;
    window.__llmProviderModelPicker.fetchOpenRouterModels = fetchOpenRouterModels;
    window.__llmProviderModelPicker._util = { safeJsonParse };
  })();
</script>
