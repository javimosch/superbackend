<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Markdowns - Admin</title>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
      .toast {
        animation: slideIn 0.3s ease-out;
      }
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      .fade-out {
        animation: fadeOut 0.3s ease-out forwards;
      }
      @keyframes fadeOut {
        from {
          opacity: 1;
        }
        to {
          opacity: 0;
        }
      }
      .tab-active {
        border-bottom: 2px solid #3b82f6;
        color: #3b82f6;
      }
      .tree-item {
        cursor: pointer;
        user-select: none;
      }
      .tree-item:hover {
        background-color: #f3f4f6;
      }
      .tree-item.selected {
        background-color: #dbeafe;
      }
      .folder-icon::before {
        content: 'üìÅ';
      }
      .folder-icon.open::before {
        content: 'üìÇ';
      }
      .file-icon::before {
        content: 'üìÑ';
      }
      .category-icon::before {
        content: 'üè∑Ô∏è';
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <div id="app">
      <div class="min-h-screen">
        <div class="bg-white shadow">
          <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex justify-between items-center">
              <div>
                <h1 class="text-2xl font-bold text-gray-900">Markdowns</h1>
                <p class="text-sm text-gray-600 mt-1">Manage markdown content with hierarchical organization and public access.</p>
              </div>
              <div class="flex items-center gap-4">
                <button @click="loadData" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 flex items-center">
                  Refresh
                </button>
                <button @click="openCreateModal" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 flex items-center">
                  New Markdown
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Tabs -->
        <div class="bg-white border-b">
          <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex space-x-8">
              <button 
                @click="activeTab = 'list'" 
                :class="['py-4 px-1 border-b-2 font-medium text-sm transition-colors', activeTab === 'list' ? 'tab-active' : 'border-transparent text-gray-500 hover:text-gray-700']">
                List View
              </button>
              <button 
                @click="activeTab = 'explorer'" 
                :class="['py-4 px-1 border-b-2 font-medium text-sm transition-colors', activeTab === 'explorer' ? 'tab-active' : 'border-transparent text-gray-500 hover:text-gray-700']">
                Explorer View
              </button>
            </div>
          </div>
        </div>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
          <!-- List Mode -->
          <div v-if="activeTab === 'list'">
            <!-- Filters -->
            <div class="bg-white rounded-lg shadow mb-6 p-4">
              <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                  <input v-model="filters.category" type="text" placeholder="Filter by category" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Group Code</label>
                  <input v-model="filters.group_code" type="text" placeholder="Filter by group code" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                  <select v-model="filters.status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All</option>
                    <option value="published">Published</option>
                    <option value="draft">Draft</option>
                    <option value="archived">Archived</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                  <input v-model="filters.search" @input="debouncedLoadData" type="text" placeholder="Search..." 
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
              </div>
            </div>

            <!-- Data Table -->
            <div class="bg-white rounded-lg shadow">
              <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Title</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Category</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Group Code</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Slug</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Public</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Updated</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                  </thead>
                  <tbody class="bg-white divide-y divide-gray-200">
                    <tr v-for="item in data.items" :key="item._id" class="hover:bg-gray-50">
                      <td class="px-4 py-3 text-sm font-medium text-gray-900">{{ item.title }}</td>
                      <td class="px-4 py-3 text-sm text-gray-500">{{ item.category }}</td>
                      <td class="px-4 py-3 text-sm text-gray-500">{{ item.group_code || '-' }}</td>
                      <td class="px-4 py-3 text-sm text-gray-500">{{ item.slug }}</td>
                      <td class="px-4 py-3 text-sm">
                        <span :class="['px-2 py-1 text-xs rounded-full', 
                          item.status === 'published' ? 'bg-green-100 text-green-800' : 
                          item.status === 'draft' ? 'bg-yellow-100 text-yellow-800' : 
                          'bg-gray-100 text-gray-800']">
                          {{ item.status }}
                        </span>
                      </td>
                      <td class="px-4 py-3 text-sm">
                        <span v-if="item.publicEnabled" class="text-green-600">‚úì</span>
                        <span v-else class="text-gray-400">-</span>
                      </td>
                      <td class="px-4 py-3 text-sm text-gray-500">{{ formatDate(item.updatedAt) }}</td>
                      <td class="px-4 py-3 text-sm">
                        <button v-if="item.publicEnabled" @click="copyPublicUrl(item)" class="text-green-600 hover:text-green-900 mr-3" title="Copy Public URL">
                          <svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>
                        </button>
                        <button @click="editItem(item)" class="text-blue-600 hover:text-blue-900 mr-3">Edit</button>
                        <button @click="deleteItem(item)" class="text-red-600 hover:text-red-900">Delete</button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              
              <!-- Pagination -->
              <div v-if="data.total > data.limit" class="px-4 py-3 border-t flex items-center justify-between">
                <div class="text-sm text-gray-700">
                  Showing {{ data.skip + 1 }} to {{ Math.min(data.skip + data.limit, data.total) }} of {{ data.total }} results
                </div>
                <div class="flex gap-2">
                  <button @click="prevPage" :disabled="!hasPrevPage" 
                    class="px-3 py-1 border rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                    Previous
                  </button>
                  <button @click="nextPage" :disabled="!hasNextPage" 
                    class="px-3 py-1 border rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                    Next
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Explorer Mode -->
          <div v-if="activeTab === 'explorer'" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Tree View -->
            <div class="bg-white rounded-lg shadow flex flex-col">
              <div class="px-4 py-3 border-b">
                <h2 class="text-lg font-semibold text-gray-900 mb-2">Categories</h2>
                <div class="flex flex-wrap gap-2">
                  <button 
                    v-for="cat in categories" 
                    :key="cat"
                    @click="toggleCategory(cat)"
                    :class="['px-2 py-1 text-xs rounded-full border transition-colors', 
                      selectedCategories.includes(cat) ? 'bg-blue-500 text-white border-blue-500' : 'bg-gray-100 text-gray-600 border-gray-200 hover:bg-gray-200']">
                    {{ cat }}
                  </button>
                </div>
              </div>
              <div class="p-4 flex-1 max-h-[600px] overflow-y-auto">
                <div v-if="selectedCategories.length === 0" class="text-gray-500 text-sm text-center py-4">
                  Select one or more categories to explore
                </div>
                <div v-else>
                  <tree-item 
                    v-for="(node, name) in treeData" 
                    :key="name" 
                    :name="name" 
                    :node="node" 
                    :path="[]"
                    @select="selectNode"
                    @toggle="toggleNode">
                  </tree-item>
                </div>
              </div>
            </div>

            <!-- Folder Contents - Windows Explorer Style -->
            <div class="lg:col-span-2 bg-white rounded-lg shadow">
              <div class="px-4 py-3 border-b">
                <div class="flex items-center justify-between">
                  <div>
                    <h2 class="text-lg font-semibold text-gray-900">Files</h2>
                    <!-- Breadcrumb Navigation -->
                    <div class="text-sm text-gray-600 mt-1">
                      <span v-if="activeCategory" class="font-medium text-gray-900">{{ activeCategory }}</span>
                      <span v-else class="italic text-gray-400">No folder selected</span>
                      <span v-for="(segment, index) in currentPath" :key="index">
                        / <button @click="navigateToFolder(index)" class="text-blue-600 hover:underline">{{ segment }}</button>
                      </span>
                    </div>
                  </div>
                  <button @click="openCreateModal" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                    New Markdown
                  </button>
                </div>
              </div>
              <div class="p-4">
                <div v-if="folderContents.items.length === 0" class="text-gray-500 text-center py-8">
                  No files in this folder
                </div>
                <div v-else class="space-y-2">
                  <!-- Files List (Windows Explorer style) -->
                  <div v-for="item in folderContents.items" 
                       :key="item._id"
                       class="flex items-center p-3 hover:bg-gray-100 rounded cursor-pointer border group">
                    <div @click="selectFileFromContent(item)" class="flex items-center flex-1">
                      <div class="w-8 h-8 bg-gray-100 rounded flex items-center justify-center mr-3">
                        <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"></path>
                        </svg>
                      </div>
                      <div class="flex-1">
                        <div class="font-medium">{{ item.title }}</div>
                        <div class="text-sm text-gray-500">{{ item.slug }} ‚Ä¢ {{ item.status }}</div>
                      </div>
                    </div>
                    <div class="flex items-center gap-2">
                      <button v-if="item.publicEnabled" @click.stop="copyPublicUrl(item)" class="p-1 text-gray-400 hover:text-green-600 rounded border border-transparent hover:border-green-200" title="Copy Public URL">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>
                      </button>
                      <div class="text-sm text-gray-400">
                        {{ formatDate(item.updatedAt) }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Create/Edit Modal -->
      <div v-if="showCreateModal || editingItem" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div :class="['bg-white shadow-xl flex flex-col transition-all duration-300', 
          zenMode ? 'w-screen h-screen rounded-none' : 'w-full mx-4 max-w-7xl h-[90vh] rounded-lg']">
          
          <!-- Modal Header -->
          <div :class="['px-6 py-4 border-b flex justify-between items-center bg-white', zenMode ? '' : 'rounded-t-lg']">
            <div class="flex items-center gap-4 flex-1">
              <h3 class="text-lg font-semibold text-gray-900 whitespace-nowrap">
                {{ editingItem ? 'Edit Markdown' : 'Create Markdown' }}
              </h3>
              <input v-if="zenMode" v-model="formData.title" type="text" placeholder="Title..."
                class="flex-1 max-w-md px-3 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex gap-2 ml-4">
              <button @click="zenMode = !zenMode" class="text-gray-500 hover:text-blue-600 p-2 rounded border border-gray-200" :title="zenMode ? 'Exit Zen Mode' : 'Zen Mode'">
                <svg v-if="!zenMode" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path></svg>
                <svg v-else class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
              </button>
              <button @click="copyToClipboard" class="text-gray-500 hover:text-blue-600 p-2 rounded border border-gray-200" title="Copy Markdown to Clipboard">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
              </button>
            </div>
          </div>

          <!-- Modal Body -->
          <div :class="['flex-1 min-h-0', zenMode ? 'p-2' : 'p-6']">
            <div class="h-full flex flex-col gap-4">
              <!-- Meta fields (Hidden in Zen Mode) -->
              <div v-if="!zenMode" class="grid grid-cols-1 md:grid-cols-2 gap-4 flex-none">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Title *</label>
                  <input v-model="formData.title" type="text" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Category *</label>
                    <input v-model="formData.category" type="text" required
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Group Code</label>
                    <input v-model="formData.group_code" type="text" placeholder="folder__subfolder"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  </div>
                </div>
              </div>

              <!-- Editor/Preview Area -->
              <div class="flex-1 grid grid-cols-1 lg:grid-cols-2 gap-6 min-h-0">
                <div class="flex flex-col h-full min-h-0">
                  <div v-if="!zenMode" class="flex justify-between items-center mb-1 flex-none">
                    <label class="block text-sm font-medium text-gray-700">Content *</label>
                    <span class="text-xs text-gray-500">Markdown supported</span>
                  </div>
                  <textarea v-model="formData.markdownRaw" required
                    class="flex-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm resize-none overflow-y-auto"></textarea>
                </div>
                <div class="flex flex-col h-full min-h-0">
                  <label v-if="!zenMode" class="block text-sm font-medium text-gray-700 mb-1 flex-none">Preview</label>
                  <div class="flex-1 border border-gray-200 rounded-md p-4 bg-gray-50 overflow-y-auto prose prose-sm max-w-none" v-html="previewHtml">
                  </div>
                </div>
              </div>

              <!-- Extra fields (Hidden in Zen Mode) -->
              <div v-if="!zenMode" class="grid grid-cols-3 gap-4 flex-none">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                  <select v-model="formData.status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="draft">Draft</option>
                    <option value="published">Published</option>
                    <option value="archived">Archived</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Public Access</label>
                  <label class="flex items-center mt-2">
                    <input v-model="formData.publicEnabled" type="checkbox" class="mr-2">
                    <span class="text-sm">Enable public access</span>
                  </label>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Cache TTL (seconds)</label>
                  <input v-model="formData.cacheTtlSeconds" type="number" min="0"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
              </div>
            </div>
          </div>

          <!-- Modal Footer -->
          <div v-if="!zenMode" class="px-6 py-4 border-t flex justify-end gap-3 bg-white rounded-b-lg">
            <button @click="closeModal" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
              Cancel
            </button>
            <button @click="saveItem" :disabled="saving" 
              class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50">
              {{ saving ? 'Saving...' : (editingItem ? 'Update' : 'Create') }}
            </button>
          </div>

          <!-- Floating Zen Footer -->
          <div v-if="zenMode" 
            :class="['fixed bottom-8 left-1/2 -translate-x-1/2 flex gap-4 bg-white/90 backdrop-blur shadow-2xl border border-gray-200 p-4 rounded-full transition-all duration-300 z-50', 
              showFloatingFooter ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-10 pointer-events-none']">
            <button @click="closeModal" class="px-6 py-2 border border-gray-300 rounded-full text-gray-700 hover:bg-gray-100 font-medium">
              Cancel
            </button>
            <button @click="saveItem" :disabled="saving" 
              class="px-8 py-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 disabled:opacity-50 font-bold shadow-lg shadow-blue-200">
              {{ saving ? 'Saving...' : (editingItem ? 'Update' : 'Create') }}
            </button>
          </div>
        </div>
      </div>

      <!-- Toast Container -->
      <div class="fixed top-4 right-4 z-50">
        <div v-for="toast in toasts" :key="toast.id" 
          :class="['toast p-4 rounded-lg shadow-lg mb-2', toast.type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white']">
          {{ toast.message }}
        </div>
      </div>
    </div>

    <script>
      const { createApp } = Vue;

      const app = createApp({
        data() {
          return {
            activeTab: 'list',
            data: { items: [], total: 0, limit: 50, skip: 0 },
            filters: { category: '', group_code: '', status: '', search: '' },
            categories: [],
            selectedCategories: [],
            activeCategory: '',
            treeData: {},
            currentPath: [],
            folderContents: { items: [], total: 0, limit: 100, skip: 0 },
            showCreateModal: false,
            editingItem: null,
            formData: {
              title: '',
              category: '',
              group_code: '',
              markdownRaw: '',
              status: 'draft',
              publicEnabled: false,
              cacheTtlSeconds: 0
            },
            saving: false,
            zenMode: false,
            showFloatingFooter: false,
            initialFormData: '',
            baseUrl: '<%= baseUrl %>',
            toasts: [],
            debounceTimer: null
          };
        },
        computed: {
          hasPrevPage() {
            return this.data.skip > 0;
          },
          hasNextPage() {
            return this.data.skip + this.data.limit < this.data.total;
          },
          previewHtml() {
            if (!this.formData.markdownRaw) return '<p class="text-gray-400 italic">No content to preview</p>';
            try {
              return marked.parse(this.formData.markdownRaw);
            } catch (e) {
              return '<p class="text-red-500">Error parsing markdown</p>';
            }
          },
          isDirty() {
            return this.initialFormData !== JSON.stringify(this.formData);
          }
        },
        methods: {
          async loadData() {
            try {
              const params = new URLSearchParams({
                ...this.filters,
                page: Math.floor(this.data.skip / this.data.limit) + 1,
                limit: this.data.limit
              });

              const response = await fetch(`<%= baseUrl %>/api/admin/markdowns?${params}`);
              const result = await response.json();
              
              if (response.ok) {
                this.data = result;
                this.extractCategories();
              } else {
                this.showToast(result.error || 'Failed to load data', 'error');
              }
            } catch (error) {
              this.showToast('Network error', 'error');
            }
          },
          debouncedLoadData() {
            clearTimeout(this.debounceTimer);
            this.debounceTimer = setTimeout(() => {
              this.data.skip = 0;
              this.loadData();
            }, 500);
          },
          extractCategories() {
            const cats = new Set(this.data.items.map(item => item.category));
            this.categories = Array.from(cats).sort();
            // If no categories selected and we have categories, select the first one by default
            if (this.selectedCategories.length === 0 && this.categories.length > 0) {
              this.toggleCategory(this.categories[0]);
            }
          },
          toggleCategory(cat) {
            const index = this.selectedCategories.indexOf(cat);
            if (index === -1) {
              this.selectedCategories.push(cat);
            } else {
              this.selectedCategories.splice(index, 1);
            }
            this.loadTree();
          },
          openCreateModal() {
            this.formData = {
              title: '',
              category: this.activeCategory || (this.selectedCategories.length > 0 ? this.selectedCategories[0] : ''),
              group_code: this.currentPath.join('__'),
              markdownRaw: '',
              status: 'draft',
              publicEnabled: false,
              cacheTtlSeconds: 0
            };
            this.initialFormData = JSON.stringify(this.formData);
            this.showCreateModal = true;
          },
          async loadTree() {
            if (this.selectedCategories.length === 0) {
              this.treeData = {};
              return;
            }
            
            try {
              // Step 1: Fetch unique group codes for all selected categories
              const results = await Promise.all(this.selectedCategories.map(async (cat) => {
                const response = await fetch(`<%= baseUrl %>/api/admin/markdowns/group-codes/${cat}`);
                const groupCodes = await response.json();
                return { category: cat, groupCodes };
              }));
              
              // Step 2: Build combined tree client-side
              this.treeData = this.buildTreeFromGroupCodes(results);
            } catch (error) {
              this.showToast('Network error loading tree', 'error');
            }
          },
          async loadFolderContents() {
            if (!this.activeCategory) return;
            
            try {
              const groupCode = this.currentPath.join('__');
              const path = groupCode ? `/${this.activeCategory}/${groupCode}` : `/${this.activeCategory}`;
              const response = await fetch(`<%= baseUrl %>/api/admin/markdowns/folder${path}`);
              const result = await response.json();
              
              if (response.ok) {
                this.folderContents = result;
              } else {
                this.showToast(result.error || 'Failed to load folder contents', 'error');
              }
            } catch (error) {
              this.showToast('Network error', 'error');
            }
          },
          selectNode(node, path) {
            if (node._type === 'file') {
              // Find and edit the file
              const item = this.data.items.find(i => 
                i.slug === node.slug && 
                i.group_code === node.group_code
              );
              if (item) this.editItem(item);
            } else {
              // Navigate to folder
              // First element of path is the category
              this.activeCategory = path[0];
              const folderPath = path.slice(1);

              if (folderPath.includes('(uncategorized)')) {
                // Special handling for uncategorized folder
                this.currentPath = []; // Empty path for root-level files
              } else {
                this.currentPath = folderPath;
              }
              this.loadFolderContents();
            }
          },
          toggleNode(name, path) {
            // Toggle folder expansion
            let current = this.treeData;
            
            // Navigate to the node
            for (let i = 0; i < path.length - 1; i++) {
              const part = path[i];
              if (current[part] && current[part].children) {
                current = current[part].children;
              }
            }
            
            if (current[name] && current[name]._type === 'folder') {
              current[name].expanded = !current[name].expanded;
            }
          },
          buildTreeFromGroupCodes(results) {
            const tree = {};
            
            results.forEach(({ category, groupCodes }) => {
              // Each category is a root folder
              tree[category] = { 
                _type: 'folder', 
                _isCategory: true, 
                expanded: true, 
                children: {} 
              };
              
              const catChildren = tree[category].children;
              
              groupCodes.forEach(groupCode => {
                if (!groupCode) {
                  // Create uncategorized folder for empty group codes
                  if (!catChildren['(uncategorized)']) {
                    catChildren['(uncategorized)'] = { _type: 'folder', children: {} };
                  }
                } else {
                  const parts = groupCode.split('__');
                  let current = catChildren;
                  
                  parts.forEach(part => {
                    if (!current[part]) {
                      current[part] = { _type: 'folder', children: {} };
                    }
                    current = current[part].children;
                  });
                }
              });
            });
            
            return tree;
          },
          editItem(item) {
            this.editingItem = item;
            this.formData = {
              title: item.title,
              category: item.category,
              group_code: item.group_code || '',
              markdownRaw: item.markdownRaw || '',
              status: item.status,
              publicEnabled: item.publicEnabled,
              cacheTtlSeconds: item.cacheTtlSeconds || 0
            };
            this.initialFormData = JSON.stringify(this.formData);
          },
          async deleteItem(item) {
            if (!confirm(`Are you sure you want to delete "${item.title}"?`)) return;
            
            try {
              const response = await fetch(`<%= baseUrl %>/api/admin/markdowns/${item._id}`, {
                method: 'DELETE'
              });
              
              if (response.ok) {
                this.showToast('Markdown deleted successfully', 'success');
                this.loadData();
                if (this.activeTab === 'explorer') {
                  this.loadTree();
                  this.loadFolderContents();
                }
              } else {
                const result = await response.json();
                this.showToast(result.error || 'Failed to delete', 'error');
              }
            } catch (error) {
              this.showToast('Network error', 'error');
            }
          },
          async saveItem() {
            this.saving = true;
            
            try {
              const url = this.editingItem 
                ? `<%= baseUrl %>/api/admin/markdowns/${this.editingItem._id}`
                : `<%= baseUrl %>/api/admin/markdowns`;
              
              const method = this.editingItem ? 'PUT' : 'POST';
              
              const response = await fetch(url, {
                method,
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(this.formData)
              });
              
              if (response.ok) {
                this.showToast(this.editingItem ? 'Markdown updated successfully' : 'Markdown created successfully', 'success');
                this.closeModal();
                this.loadData();
                if (this.activeTab === 'explorer') {
                  this.loadTree();
                  this.loadFolderContents();
                }
              } else {
                const result = await response.json();
                this.showToast(result.error || 'Failed to save', 'error');
              }
            } catch (error) {
              this.showToast('Network error', 'error');
            } finally {
              this.saving = false;
            }
          },
          closeModal() {
            this.showCreateModal = false;
            this.editingItem = null;
            this.zenMode = false;
            this.formData = {
              title: '',
              category: '',
              group_code: '',
              markdownRaw: '',
              status: 'draft',
              publicEnabled: false,
              cacheTtlSeconds: 0
            };
          },
          prevPage() {
            if (this.hasPrevPage) {
              this.data.skip -= this.data.limit;
              this.loadData();
            }
          },
          nextPage() {
            if (this.hasNextPage) {
              this.data.skip += this.data.limit;
              this.loadData();
            }
          },
          formatDate(dateStr) {
            return new Date(dateStr).toLocaleString();
          },
          showToast(message, type = 'success') {
            const toast = { id: Date.now(), message, type };
            this.toasts.push(toast);
            
            setTimeout(() => {
              const index = this.toasts.findIndex(t => t.id === toast.id);
              if (index > -1) {
                this.toasts.splice(index, 1);
              }
            }, 3000);
          },
          navigateToFolder(index) {
            this.currentPath = this.currentPath.slice(0, index + 1);
            this.loadFolderContents();
          },
          selectFileFromContent(file) {
            // Ensure file has all required data for editing
            this.editItem(file);
            
            // Auto-expand tree to show file location
            this.expandTreeToPath(file.group_code);
          },
          expandTreeToPath(groupCode) {
            if (!groupCode) return;
            
            const pathParts = groupCode.split('__');
            let current = this.treeData;
            
            // Expand each folder in the path
            for (let i = 0; i < pathParts.length; i++) {
              const part = pathParts[i];
              if (current[part] && current[part]._type === 'folder') {
                current[part].expanded = true;
                current = current[part].children;
              }
            }
          },
          async copyToClipboard() {
            if (!this.formData.markdownRaw) return;
            try {
              await navigator.clipboard.writeText(this.formData.markdownRaw);
              this.showToast('Markdown copied to clipboard', 'success');
            } catch (err) {
              this.showToast('Failed to copy to clipboard', 'error');
            }
          },
          async copyPublicUrl(item) {
            if (!item.publicEnabled) return;
            
            const groupCodePart = item.group_code ? `${item.group_code}/` : '';
            const publicUrl = `${window.location.origin}${this.baseUrl}/api/markdowns/${item.category}/${groupCodePart}${item.slug}`;
            
            try {
              await navigator.clipboard.writeText(publicUrl);
              this.showToast('Public URL copied to clipboard', 'success');
            } catch (err) {
              this.showToast('Failed to copy URL', 'error');
            }
          },
          handleMouseMove(e) {
            if (!this.zenMode) return;
            // Show footer if mouse is in the bottom 100px of the screen
            this.showFloatingFooter = (window.innerHeight - e.clientY) < 100;
          },
          handleEscKey() {
            if (this.showCreateModal || this.editingItem) {
              if (this.isDirty) {
                if (confirm('Save before closing?')) {
                  this.saveItem();
                } else {
                  this.closeModal();
                }
              } else {
                this.closeModal();
              }
              return true; // Handled
            }
            return false; // Not handled
          }
        },
        mounted() {
          this.loadData();
          window.addEventListener('mousemove', this.handleMouseMove);
        },
        beforeUnmount() {
          window.removeEventListener('mousemove', this.handleMouseMove);
        },
        watch: {
          showCreateModal(val) {
            if (val) document.body.style.overflow = 'hidden';
            else if (!this.editingItem) document.body.style.overflow = '';
          },
          editingItem(val) {
            if (val) document.body.style.overflow = 'hidden';
            else if (!this.showCreateModal) document.body.style.overflow = '';
          }
        }
      }).component('tree-item', {
        props: ['name', 'node', 'path'],
        template: `
          <div>
            <div @click="handleClick" class="tree-item px-2 py-1 rounded flex items-center justify-between">
              <div class="flex items-center">
                <span :class="['mr-2', node._isCategory ? 'category-icon' : (node._type === 'folder' ? 'folder-icon' : 'file-icon')]"></span>
                <span :class="{'font-bold': node._isCategory}">{{ name }}</span>
              </div>
              <span v-if="node._type === 'file' && node.status" :class="[
                'text-xs px-2 py-0.5 rounded',
                node.status === 'published' ? 'bg-green-100 text-green-800' : 
                node.status === 'draft' ? 'bg-yellow-100 text-yellow-800' : 
                'bg-gray-100 text-gray-800'
              ]">
                {{ node.status }}
              </span>
            </div>
            <div v-if="node._type === 'folder' && node.expanded" class="ml-4">
              <tree-item 
                v-for="(child, childName) in node.children" 
                :key="childName" 
                :name="childName" 
                :node="child" 
                :path="[...path, name]"
                @select="(node, path) => $emit('select', node, path)"
                @toggle="(name, path) => $emit('toggle', name, path)">
              </tree-item>
            </div>
          </div>
        `,
        methods: {
          handleClick() {
            if (this.node._type === 'folder') {
              this.$emit('toggle', this.name, [...this.path, this.name]);
            }
            this.$emit('select', this.node, [...this.path, this.name]);
          }
        }
      });
      
      window.app = app.mount('#app');
    </script>
    <script>
      window.addEventListener("keydown", (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === "k") {
          e.preventDefault();
          window.parent.postMessage({ type: "keydown", ctrlK: true }, "*");
        }
        if (e.key === "Escape") {
          if (window.app && window.app.handleEscKey()) {
            return;
          }
          window.parent.postMessage({ type: "keydown", key: "Escape" }, "*");
        }
      });
    </script>
  </body>
</html>
