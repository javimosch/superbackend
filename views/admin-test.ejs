<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin API Testing</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .toast {
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .fade-out {
      animation: fadeOut 0.3s ease-out forwards;
    }
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    .sidebar-group-content[data-collapsed="true"] {
      display: none;
    }
    .sidebar-group-content {
      padding-left: 1rem;
    }
    .sidebar-group-header {
      cursor: pointer;
    }
    .sidebar-group-header .caret {
      transition: transform 0.2s ease-out;
    }
    .sidebar-group-header .caret.down {
      transform: rotate(90deg);
    }
  </style>
</head>
<body class="bg-gray-100">
  <div class="flex h-screen">
    <!-- Vertical Toolbar -->
    <%- include('partials/admin-test-sidebar') %>

    <!-- Content Area -->
    <div class="flex-1 p-8 overflow-y-auto">
      <div id="content" class="max-w-4xl">
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-2xl font-bold mb-4">Welcome to API Testing</h2>
          <p class="text-gray-600">Select an endpoint from the left sidebar to begin testing.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toast-container" class="fixed top-4 right-4 space-y-2 z-50"></div>

  <script>
    const API_BASE = window.location.origin + "<%= baseUrl %>" || window.location.origin;
    const ENDPOINT_REGISTRY = <%- JSON.stringify(endpointRegistry || []) %>;
    
    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast px-6 py-4 rounded-lg shadow-lg text-white ${
        type === 'success' ? 'bg-green-500' : 'bg-red-500'
      }`;
      toast.textContent = message;
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.classList.add('fade-out');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    async function makeRequest(endpoint, method, body = null, requiresJWT = false) {
      const headers = { 'Content-Type': 'application/json' };
      
      if (requiresJWT) {
        const token = document.getElementById('jwt-input')?.value;
        if (!token) {
          showToast('JWT token required', 'error');
          return;
        }
        headers['Authorization'] = `Bearer ${token}`;
      }
      
      const options = { method, headers };
      if (body) options.body = JSON.stringify(body);
      
      try {
        const response = await fetch(`${API_BASE}${endpoint}`, options);
        const data = await response.json();
        
        const responseEl = document.querySelector('#content pre#response');
        if (response.ok) {
          showToast('Request successful!', 'success');
          if (responseEl) responseEl.textContent = JSON.stringify(data, null, 2);
        } else {
          showToast(data.error || 'Request failed', 'error');
          if (responseEl) responseEl.textContent = JSON.stringify(data, null, 2);
        }
      } catch (error) {
        showToast(error.message, 'error');
        const responseEl = document.querySelector('#content pre#response');
        if (responseEl) responseEl.textContent = error.message;
      }
    }

    function getPathParams(pathTemplate) {
      const matches = pathTemplate.match(/:[^/]+/g);
      if (!matches) return [];
      return matches.map((m) => m.substring(1));
    }

    function applyPathParams(pathTemplate, params) {
      let path = pathTemplate;
      Object.entries(params).forEach(([key, value]) => {
        path = path.replace(`:${key}`, encodeURIComponent(value));
      });
      return path;
    }

    function renderSidebar() {
      const sidebar = document.getElementById('endpoint-sidebar');
      if (!sidebar) return;

      sidebar.innerHTML = '';

      const searchEl = document.getElementById('sidebar-search');
      const searchValue = (searchEl?.value || '').trim().toLowerCase();

      ENDPOINT_REGISTRY.forEach((group) => {
        const groupEl = document.createElement('div');
        groupEl.className = 'mb-4';

        const headerBtn = document.createElement('button');
        headerBtn.type = 'button';
        headerBtn.className = 'w-full flex items-center justify-between text-sm font-semibold text-gray-400 mb-2 px-2 py-1 rounded hover:bg-gray-700 transition sidebar-group-header';

        const headerTitle = document.createElement('span');
        headerTitle.textContent = group.title;
        headerBtn.appendChild(headerTitle);

        const caret = document.createElement('span');
        caret.className = 'text-gray-500 caret';
        caret.textContent = '‚ñ∏';
        headerBtn.appendChild(caret);

        const groupContent = document.createElement('div');
        groupContent.className = 'sidebar-group-content space-y-1';
        groupContent.dataset.groupId = group.id;
        groupContent.dataset.collapsed = 'true';

        headerBtn.onclick = () => {
          const collapsed = groupContent.dataset.collapsed === 'true';
          groupContent.dataset.collapsed = collapsed ? 'false' : 'true';
          caret.className = collapsed ? 'text-gray-500 caret down' : 'text-gray-500 caret';
        };

        groupEl.appendChild(headerBtn);
        groupEl.appendChild(groupContent);

        const dedicatedPages = {
          'global-settings': { href: '/admin/global-settings', label: 'üîß Settings Manager UI ‚Üí' },
          'forms': { href: '/admin/forms', label: 'üìù Forms Admin UI ‚Üí' },
          'waiting-list': { href: '/admin/waiting-list', label: 'üìã Waiting List UI ‚Üí' },
          'metrics': { href: '/admin/metrics', label: 'üìä Metrics UI ‚Üí' },
          'feature-flags': { href: '/admin/feature-flags', label: 'üö© Feature Flags UI ‚Üí' },
          'i18n': { href: '/admin/i18n', label: 'üåê i18n Manager UI ‚Üí' },
        };

        if (dedicatedPages[group.id]) {
          const link = document.createElement('a');
          link.href = dedicatedPages[group.id].href;
          link.className = 'block w-full text-left px-4 py-2 rounded hover:bg-gray-700 transition text-green-400';
          link.textContent = dedicatedPages[group.id].label;
          groupContent.appendChild(link);
        }

        const groupSearchText = `${group.title} ${(dedicatedPages[group.id]?.label || '')}`.toLowerCase();
        let groupMatches = !searchValue || groupSearchText.includes(searchValue);

        group.endpoints.forEach((ep) => {
          const label = `${ep.method} ${ep.path}`;
          const matches = !searchValue || label.toLowerCase().includes(searchValue) || groupSearchText.includes(searchValue);
          if (!matches) return;
          groupMatches = true;

          const btn = document.createElement('button');
          btn.className = 'w-full text-left px-4 py-2 rounded hover:bg-gray-700 transition';
          btn.textContent = label;
          btn.onclick = () => showEndpoint(group.id, ep.id);
          groupContent.appendChild(btn);
        });

        if (!groupMatches) return;

        if (searchValue) {
          groupContent.dataset.collapsed = 'false';
          caret.className = 'text-gray-500 caret down';
        }

        sidebar.appendChild(groupEl);
      });
    }

    function showEndpoint(groupId, endpointId) {
      const content = document.getElementById('content');
      const group = ENDPOINT_REGISTRY.find((g) => g.id === groupId);
      const ep = group?.endpoints?.find((e) => e.id === endpointId);
      if (!content || !ep) return;

      const requiresJWT = ep.auth === 'jwt';
      const pathParams = getPathParams(ep.path);

      content.innerHTML = `
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-2xl font-bold mb-4">${ep.method} ${ep.path}</h2>
          ${requiresJWT ? `
            <div class="bg-yellow-100 border-l-4 border-yellow-500 p-4 mb-4">
              <p class="text-sm">‚ö†Ô∏è This endpoint requires JWT authentication</p>
            </div>
          ` : ''}
          <form id="endpoint-form">
            ${requiresJWT ? `
              <div class="mb-4">
                <label class="block text-sm font-medium mb-2">JWT Token</label>
                <textarea id="jwt-input" class="w-full border rounded px-3 py-2" rows="4" required></textarea>
              </div>
            ` : ''}
            ${pathParams.map((p) => `
              <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Path param: ${p}</label>
                <input type="text" id="param-${p}" class="w-full border rounded px-3 py-2" required>
              </div>
            `).join('')}
            ${ep.method !== 'GET' && ep.method !== 'DELETE' ? `
              <div class="mb-4">
                <label class="block text-sm font-medium mb-2">JSON Body</label>
                <textarea id="json-body" class="w-full border rounded px-3 py-2 font-mono text-sm" rows="8">${JSON.stringify(ep.bodyExample || {}, null, 2)}</textarea>
              </div>
            ` : ''}
            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Send Request</button>
          </form>
          <div class="mt-6">
            <h3 class="font-semibold mb-2">Response:</h3>
            <pre id="response" class="bg-gray-100 p-4 rounded overflow-auto max-h-96"></pre>
          </div>
        </div>
      `;

      const form = document.getElementById('endpoint-form');
      if (!form) return;

      form.onsubmit = (event) => {
        event.preventDefault();

        const params = {};
        pathParams.forEach((p) => {
          params[p] = document.getElementById(`param-${p}`)?.value;
        });

        const resolvedPath = applyPathParams(ep.path, params);

        let body = null;
        if (ep.method !== 'GET' && ep.method !== 'DELETE') {
          const rawBody = document.getElementById('json-body')?.value;
          try {
            body = rawBody ? JSON.parse(rawBody) : {};
          } catch (e) {
            showToast(`Invalid JSON body: ${e.message}`, 'error');
            return;
          }
        }

        makeRequest(resolvedPath, ep.method, body, requiresJWT);
      };
    }

    const searchEl = document.getElementById('sidebar-search');
    if (searchEl) {
      searchEl.addEventListener('input', () => renderSidebar());
    }

    renderSidebar();
  </script>
</body>
</html>