<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Superbackend Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/dist/tabler-icons.min.css">
    <style>
        [v-cloak] { display: none; }
        .sidebar-link.active { @apply bg-blue-50 text-blue-700 border-r-4 border-blue-700; }
    </style>
</head>
<body class="bg-gray-50 overflow-hidden">
    <div id="app" class="h-screen flex flex-col" v-cloak>
        <!-- Top Header -->
        <header v-if="!globalZenMode" class="bg-white border-b border-gray-200 h-16 flex items-center justify-between px-6 shrink-0">
            <div class="flex items-center gap-4">
                <i class="ti ti-layout-dashboard text-2xl text-blue-600"></i>
                <h1 class="text-xl font-bold text-gray-800">
                    SuperBackend <span class="text-xs font-normal text-gray-500 ml-2 align-middle">(@intranefr/superbackend)</span>
                </h1>
            </div>
            <div class="flex items-center gap-6">
                <div class="hidden md:flex items-center gap-2 text-xs text-gray-400 bg-gray-50 px-3 py-1.5 rounded-lg border border-gray-200">
                    <kbd class="px-1.5 py-0.5 bg-white border border-gray-300 rounded shadow-sm font-sans">Ctrl</kbd>
                    <span>+</span>
                    <kbd class="px-1.5 py-0.5 bg-white border border-gray-300 rounded shadow-sm font-sans">K</kbd>
                    <span class="ml-1">to search</span>
                </div>
                <div class="flex items-center gap-4">
                    <!-- User Info & Logout -->
                    <div class="flex items-center gap-3">
                        <div class="text-right">
                            <div class="text-sm font-medium text-gray-700">{{ currentUser.name || currentUser.username || 'Admin User' }}</div>
                            <div class="text-xs text-gray-500">{{ currentUser.email || currentUser.authType + ' authentication' }}</div>
                        </div>
                        <div class="relative">
                            <button 
                                @click="showUserMenu = !showUserMenu" 
                                class="flex items-center justify-center w-8 h-8 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition-colors">
                                <i class="ti ti-user text-sm"></i>
                            </button>
                            
                            <!-- User Dropdown Menu -->
                            <div v-if="showUserMenu" class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-50">
                                <div class="px-4 py-2 border-b border-gray-100">
                                    <div class="text-sm font-medium text-gray-900">{{ currentUser.name || currentUser.username || 'Admin User' }}</div>
                                    <div class="text-xs text-gray-500">{{ currentUser.role }}</div>
                                </div>
                                <button 
                                    @click="handleLogout" 
                                    class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition-colors flex items-center gap-2">
                                    <i class="ti ti-logout"></i>
                                    Logout
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <button @click="globalZenMode = !globalZenMode" class="text-gray-500 hover:text-blue-600 p-1.5 rounded-lg border border-gray-200 bg-white" title="Toggle Global Zen Mode (ESC ESC to exit)">
                        <i class="ti ti-maximize"></i>
                    </button>
                    <span class="text-sm text-gray-500">v1.0.0</span>
                    <a :href="baseUrl + adminBase + '/api/test'" target="_blank" class="text-sm text-blue-600 hover:underline">API Test</a>
                </div>
            </div>
        </header>

        <div class="flex-1 flex overflow-hidden">
            <template v-if="!globalZenMode">
                <%- include('partials/dashboard/sidebar') %>
            </template>

            <!-- Main Content Area -->
            <main class="flex-1 flex flex-col overflow-hidden bg-gray-50">
                <template v-if="!globalZenMode">
                    <%- include('partials/dashboard/tab-bar') %>
                </template>
                
                <div class="flex-1 relative">
                    <!-- Iframes -->
                    <iframe 
                        v-for="tab in tabs"
                        v-show="activeTabId === tab.id"
                        :key="tab.id"
                        :src="baseUrl + tab.path" 
                        class="absolute inset-0 w-full h-full border-none"
                        :id="'frame-' + tab.id"
                    ></iframe>

                    <!-- Empty State -->
                    <div v-if="tabs.length === 0" class="flex items-center justify-center h-full text-gray-400">
                        <div class="text-center">
                            <i class="ti ti-layout-dashboard text-6xl mb-4 opacity-20"></i>
                            <p class="text-lg font-medium">No open modules</p>
                            <p class="text-sm opacity-60">Select a module from the sidebar or press Ctrl+K</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <%- include('partials/dashboard/palette') %>
    </div>

    <script>
        // Initialize globals from EJS locals first (must run before nav-items)
        window.BASE_URL = '<%= baseUrl %>';
        window.ADMIN_PATH = '<%= adminPath %>';
    </script>

    <%- include('partials/dashboard/nav-items') %>

    <script>
        const { createApp, ref, computed, nextTick, onMounted, onUnmounted, watch } = Vue;

        createApp({
            setup() {
                const baseUrl = window.BASE_URL;
                const adminBase = window.ADMIN_PATH || '/admin';
                const navSections = window.NAV_SECTIONS || [];
                
                // Tabs state
                const tabs = ref([]);
                const activeTabId = ref(null);
                const globalZenMode = ref(false);
                
                // User authentication state
                const currentUser = ref({});
                const showUserMenu = ref(false);

                // ESC ESC to exit Zen Mode
                let escCount = 0;
                let escTimeout = null;

                // localStorage utilities
                const STORAGE_KEY = 'adminDashboardTabs';
                
                const saveTabsToStorage = () => {
                    try {
                        const data = {
                            tabs: tabs.value,
                            activeTabId: activeTabId.value
                        };
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                    } catch (error) {
                        console.warn('Failed to save tabs to localStorage:', error);
                    }
                    // Always save to URL as fallback
                    saveTabsToURL();
                };
                
                const loadTabsFromStorage = () => {
                    // Try localStorage first
                    try {
                        const stored = localStorage.getItem(STORAGE_KEY);
                        if (stored) {
                            const data = JSON.parse(stored);
                            if (data && Array.isArray(data.tabs)) {
                                // Validate tabs have required fields
                                const validTabs = data.tabs.filter(tab => 
                                    tab && 
                                    typeof tab.id === 'string' && 
                                    typeof tab.label === 'string' && 
                                    typeof tab.path === 'string'
                                );
                                
                                // Ensure tabs still exist in available modules
                                const availableModuleIds = allModules.value.map(m => m.id);
                                const existingTabs = validTabs.filter(tab => 
                                    availableModuleIds.includes(tab.id)
                                );
                                
                                if (existingTabs.length > 0) {
                                    return {
                                        tabs: existingTabs,
                                        activeTabId: existingTabs.some(t => t.id === data.activeTabId) 
                                            ? data.activeTabId 
                                            : (existingTabs.length > 0 ? existingTabs[0].id : null)
                                    };
                                }
                            }
                        }
                    } catch (error) {
                        console.warn('Failed to load tabs from localStorage:', error);
                    }
                    
                    // Fallback to URL parameters
                    return loadTabsFromURL();
                };

                // URL utilities for fallback persistence
                let urlUpdateTimeout = null;
                
                const saveTabsToURL = () => {
                    clearTimeout(urlUpdateTimeout);
                    urlUpdateTimeout = setTimeout(() => {
                        try {
                            const url = new URL(window.location);
                            
                            if (tabs.value.length > 0) {
                                const tabIds = tabs.value.map(t => t.id).join(',');
                                url.searchParams.set('openTabs', tabIds);
                                if (activeTabId.value) {
                                    url.searchParams.set('activeTab', activeTabId.value);
                                }
                            } else {
                                url.searchParams.delete('openTabs');
                                url.searchParams.delete('activeTab');
                            }
                            
                            // Update URL without page reload
                            window.history.replaceState({}, '', url);
                        } catch (error) {
                            console.warn('Failed to save tabs to URL:', error);
                        }
                    }, 300); // Debounce URL updates
                };
                
                const loadTabsFromURL = () => {
                    try {
                        const url = new URL(window.location);
                        const openTabsParam = url.searchParams.get('openTabs');
                        const activeTabParam = url.searchParams.get('activeTab');
                        
                        if (!openTabsParam) return null;
                        
                        // Parse comma-separated tab IDs
                        const tabIds = openTabsParam.split(',').filter(id => id.trim());
                        if (tabIds.length === 0) return null;
                        
                        // Get available modules
                        const availableModules = allModules.value;
                        
                        // Reconstruct full tab objects from IDs
                        const tabs = tabIds.map(id => {
                            const module = availableModules.find(m => m.id === id);
                            if (module) {
                                return {
                                    id: module.id,
                                    label: module.label,
                                    icon: module.icon,
                                    path: module.path
                                };
                            }
                            return null;
                        }).filter(tab => tab !== null);
                        
                        if (tabs.length === 0) return null;
                        
                        return {
                            tabs,
                            activeTabId: tabs.some(t => t.id === activeTabParam) 
                                ? activeTabParam 
                                : tabs[0].id
                        };
                    } catch (error) {
                        console.warn('Failed to load tabs from URL:', error);
                        return null;
                    }
                };

                // Palette state
                const showPalette = ref(false);
                const paletteQuery = ref('');
                const paletteCursor = ref(0);
                const paletteInput = ref(null);
                
                // Toggle safeguards and debugging
                let toggleTimeout = null;
                let lastToggleTime = 0;

                // Flattened modules for search
                const allModules = computed(() => {
                    const modules = [];
                    if (Array.isArray(navSections)) {
                        navSections.forEach(section => {
                            if (section && Array.isArray(section.items)) {
                                section.items.forEach(item => {
                                    modules.push({
                                        ...item,
                                        sectionTitle: section.title || 'Other'
                                    });
                                });
                            }
                        });
                    }
                    return modules;
                });

                const filteredModules = computed(() => {
                    const mods = allModules.value;
                    if (!paletteQuery.value) return mods;
                    const query = paletteQuery.value.toLowerCase();
                    return mods.filter(m => 
                        (m.label && m.label.toLowerCase().includes(query)) || 
                        (m.sectionTitle && m.sectionTitle.toLowerCase().includes(query))
                    );
                });

                // Tab methods
                const openTab = (item) => {
                    if (!item || !item.id) return;
                    const existing = tabs.value.find(t => t.id === item.id);
                    if (!existing) {
                        tabs.value.push({
                            id: item.id,
                            label: item.label,
                            icon: item.icon,
                            path: item.path
                        });
                    }
                    activeTabId.value = item.id;
                    saveTabsToStorage();
                    closePalette();
                };

                const closeTab = (id) => {
                    const index = tabs.value.findIndex(t => t.id === id);
                    if (index === -1) return;
                    
                    const wasActive = activeTabId.value === id;
                    tabs.value.splice(index, 1);
                    
                    if (wasActive && tabs.value.length > 0) {
                        const nextTab = tabs.value[Math.min(index, tabs.value.length - 1)];
                        activeTabId.value = nextTab.id;
                    } else if (tabs.value.length === 0) {
                        activeTabId.value = null;
                    }
                    saveTabsToStorage();
                };

                // Palette methods
                const togglePalette = (source = 'unknown') => {
                    // Prevent rapid successive toggles
                    const now = Date.now();
                    if (now - lastToggleTime < 100) {
                        return;
                    }
                    lastToggleTime = now;
                    
                    clearTimeout(toggleTimeout);
                    
                    showPalette.value = !showPalette.value;
                    if (showPalette.value) {
                        paletteQuery.value = '';
                        paletteCursor.value = 0;
                        // Use setTimeout instead of nextTick for better timing
                        toggleTimeout = setTimeout(() => {
                            if (paletteInput.value) {
                                paletteInput.value.focus();
                            }
                        }, 50);
                    }
                };

                const closePalette = (source = 'unknown') => {
                    if (showPalette.value) {
                        showPalette.value = false;
                        clearTimeout(toggleTimeout);
                    }
                };

                const navigatePalette = (dir) => {
                    const len = filteredModules.value.length;
                    if (len === 0) return;
                    paletteCursor.value = (paletteCursor.value + dir + len) % len;
                    
                    nextTick(() => {
                        const items = document.querySelectorAll('.palette-item');
                        const el = items[paletteCursor.value];
                        if (el) el.scrollIntoView({ block: 'nearest' });
                    });
                };

                const selectPaletteItem = () => {
                    const item = filteredModules.value[paletteCursor.value];
                    if (item) openTab(item);
                };

                const selectModule = (item) => {
                    openTab(item);
                };

                // Keyboard events
                const handleKeydown = (e) => {
                    if (e.key === 'Escape') {
                        escCount++;
                        clearTimeout(escTimeout);
                        if (escCount >= 2) {
                            globalZenMode.value = false;
                            escCount = 0;
                        } else {
                            escTimeout = setTimeout(() => {
                                escCount = 0;
                            }, 500);
                        }
                    }

                    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                        e.preventDefault();
                        e.stopPropagation();
                        togglePalette('keyboard-ctrl-k');
                    }
                };

                const handleMessage = (e) => {
                    if (e.data && e.data.type === 'keydown') {
                        if (e.data.ctrlK) {
                            togglePalette('iframe-message');
                        }
                        if (e.data.key === 'Escape') {
                            handleKeydown({ key: 'Escape' });
                        }
                    }
                };

                // User authentication functions
                const fetchCurrentUser = async () => {
                    try {
                        const response = await fetch(`${adminBase}/auth-status`);
                        if (response.ok) {
                            const userData = await response.json();
                            if (userData.authenticated) {
                                currentUser.value = userData.user || {};
                            }
                        }
                    } catch (error) {
                        console.error('Failed to fetch user data:', error);
                        // Set default user data on error
                        currentUser.value = { name: 'Admin User', authType: 'unknown' };
                    }
                };

                const handleLogout = async () => {
                    try {
                        const response = await fetch(`${adminBase}/logout`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            }
                        });
                        
                        if (response.redirected) {
                            window.location.href = response.url;
                        } else {
                            // Fallback redirect
                            window.location.href = `${adminBase}/login`;
                        }
                    } catch (error) {
                        console.error('Logout error:', error);
                        // Fallback redirect
                        window.location.href = `${adminBase}/login`;
                    }
                };

                // Close user menu when clicking outside
                const handleClickOutside = (event) => {
                    if (showUserMenu.value && !event.target.closest('.relative')) {
                        showUserMenu.value = false;
                    }
                };

                onMounted(() => {
                    window.addEventListener('keydown', handleKeydown);
                    window.addEventListener('message', handleMessage);
                    window.addEventListener('click', handleClickOutside);
                    
                    // Fetch current user data
                    fetchCurrentUser();
                    
                    // Load saved tabs from localStorage
                    const savedState = loadTabsFromStorage();
                    if (savedState && savedState.tabs.length > 0) {
                        tabs.value = savedState.tabs;
                        activeTabId.value = savedState.activeTabId;
                    } else {
                        // Open default tab if no saved state
                        if (allModules.value.length > 0) {
                            const defaultModule = allModules.value.find(m => m.id === 'overview') || allModules.value[0];
                            if (defaultModule) openTab(defaultModule);
                        }
                    }
                });

                // Watch for activeTabId changes (when user clicks on tabs)
                watch(activeTabId, () => {
                    saveTabsToStorage();
                });

                onUnmounted(() => {
                    window.removeEventListener('keydown', handleKeydown);
                    window.removeEventListener('message', handleMessage);
                    window.removeEventListener('click', handleClickOutside);
                });

                return {
                    baseUrl,
                    adminBase,
                    navSections,
                    tabs,
                    activeTabId,
                    globalZenMode,
                    currentUser,
                    showUserMenu,
                    openTab,
                    closeTab,
                    showPalette,
                    paletteQuery,
                    paletteCursor,
                    paletteInput,
                    filteredModules,
                    togglePalette,
                    closePalette,
                    navigatePalette,
                    selectPaletteItem,
                    selectModule,
                    handleLogout
                };
            }
        }).mount('#app');
    </script>
<script>
  window.addEventListener("keydown", (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === "k") {
      e.preventDefault();
      window.parent.postMessage({ type: "keydown", ctrlK: true }, "*");
    }
  });
</script>
</body>
</html>
