<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Error Tracking - Admin</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
</head>
<body class="bg-gray-100">
  <div class="min-h-screen">
    <div class="bg-white shadow">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="flex justify-between items-center">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">Error Tracking</h1>
            <p class="text-sm text-gray-600 mt-1">Aggregated errors from frontend and backend</p>
          </div>
          <div class="flex items-center gap-4">
            <a href="/admin/test" class="text-blue-600 hover:text-blue-800">← Back to API Test</a>
          </div>
        </div>
      </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
        <div class="flex gap-4 text-sm">
          <div class="bg-white border border-gray-200 rounded-lg px-4 py-2">
            <span class="text-gray-500">Open:</span>
            <span id="stat-open" class="text-orange-600 font-semibold ml-1">—</span>
          </div>
          <div class="bg-white border border-gray-200 rounded-lg px-4 py-2">
            <span class="text-gray-500">Last 24h:</span>
            <span id="stat-24h" class="text-blue-600 font-semibold ml-1">—</span>
          </div>
        </div>
        <button onclick="refreshAll()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Refresh</button>
      </div>

      <details class="bg-white border border-gray-200 rounded-xl p-4 mb-6">
        <summary class="cursor-pointer select-none text-sm font-semibold text-gray-900">Quick integration (browser SDK)</summary>
        <div class="mt-4 space-y-4">
          <div>
            <div class="text-xs font-semibold text-gray-600 uppercase tracking-wide mb-2">Embed SDK</div>
            <div class="relative">
              <pre class="p-3 bg-gray-50 rounded text-xs overflow-x-auto"><code id="snippet-embed">&lt;script src="<%= baseUrl %>/api/error-tracking/browser-sdk"&gt;&lt;/script&gt;</code></pre>
              <button type="button" class="absolute top-2 right-2 text-xs px-2 py-1 bg-white border border-gray-200 rounded hover:border-blue-500" onclick="copySnippet('snippet-embed')">Copy</button>
            </div>
          </div>

          <div>
            <div class="text-xs font-semibold text-gray-600 uppercase tracking-wide mb-2">Identify user (JWT header)</div>
            <div class="relative">
              <pre class="p-3 bg-gray-50 rounded text-xs overflow-x-auto"><code id="snippet-jwt">saasbackend.errorTracking.config({
  headers: { authorization: "Bearer XXX" }
})</code></pre>
              <button type="button" class="absolute top-2 right-2 text-xs px-2 py-1 bg-white border border-gray-200 rounded hover:border-blue-500" onclick="copySnippet('snippet-jwt')">Copy</button>
            </div>
          </div>

          <div>
            <div class="text-xs font-semibold text-gray-600 uppercase tracking-wide mb-2">Future npm package (bundlers)</div>
            <div class="relative">
              <pre class="p-3 bg-gray-50 rounded text-xs overflow-x-auto"><code id="snippet-npm">import { createErrorTrackingClient } from '@saasbackend/sdk/error-tracking/browser';

const client = createErrorTrackingClient({
  endpoint: '/api/log/error',
  headers: { authorization: `Bearer ${token}` },
});

client.init();</code></pre>
              <button type="button" class="absolute top-2 right-2 text-xs px-2 py-1 bg-white border border-gray-200 rounded hover:border-blue-500" onclick="copySnippet('snippet-npm')">Copy</button>
            </div>
          </div>
        </div>
      </details>

      <div class="bg-white border border-gray-200 rounded-xl p-4 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
          <select id="filter-source" class="border rounded px-3 py-2 text-sm">
            <option value="">All Sources</option>
            <option value="frontend">Frontend</option>
            <option value="backend">Backend</option>
          </select>
          <select id="filter-severity" class="border rounded px-3 py-2 text-sm">
            <option value="">All Severities</option>
            <option value="fatal">Fatal</option>
            <option value="error">Error</option>
            <option value="warn">Warning</option>
            <option value="info">Info</option>
          </select>
          <select id="filter-status" class="border rounded px-3 py-2 text-sm">
            <option value="">All Status</option>
            <option value="open">Open</option>
            <option value="ignored">Ignored</option>
            <option value="resolved">Resolved</option>
          </select>
          <select id="filter-since" class="border rounded px-3 py-2 text-sm">
            <option value="">All Time</option>
            <option value="1">Last 24 hours</option>
            <option value="7">Last 7 days</option>
            <option value="30">Last 30 days</option>
          </select>
          <input id="filter-search" type="text" placeholder="Search..." class="border rounded px-3 py-2 text-sm" />
        </div>
        <div class="mt-3 flex justify-end">
          <button id="btn-filter" class="bg-gray-900 text-white px-4 py-2 rounded hover:bg-gray-800 text-sm">Filter</button>
        </div>
      </div>

      <div class="bg-white border border-gray-200 rounded-xl overflow-hidden">
        <table class="w-full">
          <thead class="bg-gray-50">
            <tr class="text-left text-xs uppercase tracking-wide text-gray-500">
              <th class="px-4 py-3">Error</th>
              <th class="px-4 py-3 w-24">Source</th>
              <th class="px-4 py-3 w-24">Severity</th>
              <th class="px-4 py-3 w-24 text-right">Count</th>
              <th class="px-4 py-3 w-48">Last Seen</th>
              <th class="px-4 py-3 w-24">Status</th>
              <th class="px-4 py-3 w-24"></th>
            </tr>
          </thead>
          <tbody id="errors-table" class="divide-y divide-gray-100">
            <tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">Loading...</td></tr>
          </tbody>
        </table>
      </div>

      <div class="flex items-center justify-between mt-4 text-sm text-gray-600">
        <div id="pagination-info"></div>
        <div class="flex gap-2">
          <button id="btn-prev" class="px-3 py-1 bg-white border border-gray-300 rounded hover:border-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">Prev</button>
          <button id="btn-next" class="px-3 py-1 bg-white border border-gray-300 rounded hover:border-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
        </div>
      </div>
    </div>
  </div>

  <div id="modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
      <div class="flex items-center justify-between px-6 py-4 border-b">
        <h2 id="modal-title" class="text-xl font-bold text-gray-900">Error Details</h2>
        <button id="modal-close" class="text-gray-500 hover:text-gray-800">Close</button>
      </div>
      <div id="modal-content" class="flex-1 overflow-y-auto p-6"></div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin + "<%= baseUrl %>" || window.location.origin;
    let currentPage = 1;
    const pageSize = 20;
    let totalPages = 1;

    async function copySnippet(id) {
      try {
        const el = document.getElementById(id);
        const text = el ? (el.textContent || '') : '';
        if (!text) return;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
          return;
        }

        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.left = '-9999px';
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
      } catch (e) {}
    }

    async function loadStats() {
      try {
        const res = await fetch(`${API_BASE}/api/admin/errors/stats`);
        if (!res.ok) return;
        const stats = await res.json();
        document.getElementById('stat-open').textContent = stats.open ?? 0;
        document.getElementById('stat-24h').textContent = stats.last24h ?? 0;
      } catch (e) {}
    }

    async function loadErrors() {
      const source = document.getElementById('filter-source').value;
      const severity = document.getElementById('filter-severity').value;
      const status = document.getElementById('filter-status').value;
      const sinceDays = document.getElementById('filter-since').value;
      const q = document.getElementById('filter-search').value;

      const params = new URLSearchParams();
      if (source) params.set('source', source);
      if (severity) params.set('severity', severity);
      if (status) params.set('status', status);
      if (q) params.set('q', q);
      if (sinceDays) {
        const since = new Date(Date.now() - parseInt(sinceDays) * 24 * 60 * 60 * 1000).toISOString();
        params.set('since', since);
      }
      params.set('page', currentPage);
      params.set('pageSize', pageSize);

      try {
        const res = await fetch(`${API_BASE}/api/admin/errors?` + params.toString());
        if (!res.ok) throw new Error('Failed to load errors');
        const data = await res.json();
        totalPages = data.totalPages || 1;
        renderErrors(data.errors || []);
        renderPagination(data);
      } catch (e) {
        document.getElementById('errors-table').innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-red-600">Failed to load errors</td></tr>';
      }
    }

    function renderErrors(errors) {
      const tbody = document.getElementById('errors-table');
      if (!errors.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">No errors found</td></tr>';
        return;
      }

      tbody.innerHTML = errors.map(err => {
        const sourceBadge = err.source === 'frontend'
          ? '<span class="px-2 py-1 text-xs rounded bg-purple-100 text-purple-700">frontend</span>'
          : '<span class="px-2 py-1 text-xs rounded bg-blue-100 text-blue-700">backend</span>';

        const statusColor = err.status === 'open' ? 'text-orange-600' : (err.status === 'resolved' ? 'text-green-600' : 'text-gray-500');

        return `
          <tr class="hover:bg-gray-50 cursor-pointer" onclick="showDetails('${err._id}')">
            <td class="px-4 py-3">
              <div class="text-gray-900 font-medium">${escapeHtml(err.errorName || 'Error')}</div>
              <div class="text-gray-500 text-sm truncate max-w-xl">${escapeHtml(err.messageTemplate || '')}</div>
            </td>
            <td class="px-4 py-3">${sourceBadge}</td>
            <td class="px-4 py-3 text-sm text-gray-700">${escapeHtml(err.severity)}</td>
            <td class="px-4 py-3 text-right font-mono text-gray-900">${(err.countTotal || 0).toLocaleString()}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${formatDate(err.lastSeenAt)}</td>
            <td class="px-4 py-3 text-sm ${statusColor}">${escapeHtml(err.status)}</td>
            <td class="px-4 py-3"><button onclick="event.stopPropagation(); showDetails('${err._id}')" class="text-blue-600 hover:underline text-sm">View</button></td>
          </tr>
        `;
      }).join('');
    }

    function renderPagination(data) {
      document.getElementById('pagination-info').textContent = `Page ${data.page} of ${data.totalPages} (${data.total} total)`;
      document.getElementById('btn-prev').disabled = data.page <= 1;
      document.getElementById('btn-next').disabled = data.page >= data.totalPages;
    }

    async function showDetails(id) {
      try {
        const res = await fetch(`${API_BASE}/api/admin/errors/${id}`);
        if (!res.ok) throw new Error('Failed to load details');
        const err = await res.json();
        renderModal(err);
      } catch (e) {
        alert('Failed to load error details');
      }
    }

    function renderModal(err) {
      document.getElementById('modal-title').textContent = err.errorName || 'Error Details';
      const samples = (err.samples || []).slice().reverse();

      document.getElementById('modal-content').innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-6 text-sm">
          <div><span class="text-gray-500">Source:</span> <span class="ml-2 text-gray-900">${escapeHtml(err.source)}</span></div>
          <div><span class="text-gray-500">Severity:</span> <span class="ml-2 text-gray-900">${escapeHtml(err.severity)}</span></div>
          <div><span class="text-gray-500">Status:</span> <span class="ml-2 text-gray-900">${escapeHtml(err.status)}</span></div>
          <div><span class="text-gray-500">Total Count:</span> <span class="ml-2 text-gray-900">${(err.countTotal || 0).toLocaleString()}</span></div>
          <div><span class="text-gray-500">First Seen:</span> <span class="ml-2 text-gray-900">${formatDate(err.firstSeenAt)}</span></div>
          <div><span class="text-gray-500">Last Seen:</span> <span class="ml-2 text-gray-900">${formatDate(err.lastSeenAt)}</span></div>
        </div>

        <div class="mb-4">
          <div class="text-gray-500 text-sm">Message Template</div>
          <div class="mt-1 p-3 bg-gray-50 rounded font-mono text-xs overflow-x-auto">${escapeHtml(err.messageTemplate || '')}</div>
        </div>

        <div class="mb-6 flex gap-2">
          <button onclick="updateStatus('${err._id}', 'open')" class="px-3 py-1 text-sm rounded ${err.status === 'open' ? 'bg-orange-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}">Open</button>
          <button onclick="updateStatus('${err._id}', 'ignored')" class="px-3 py-1 text-sm rounded ${err.status === 'ignored' ? 'bg-gray-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}">Ignored</button>
          <button onclick="updateStatus('${err._id}', 'resolved')" class="px-3 py-1 text-sm rounded ${err.status === 'resolved' ? 'bg-green-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}">Resolved</button>
        </div>

        <h3 class="text-lg font-bold text-gray-900 mb-3">Recent Samples (${samples.length})</h3>
        <div class="space-y-4">
          ${samples.map(s => `
            <div class="border border-gray-200 rounded-lg p-4">
              <div class="flex justify-between items-start mb-2">
                <span class="text-xs text-gray-500">${formatDate(s.at)}</span>
                <span class="text-xs text-gray-500">${escapeHtml(s.actor?.ip || 'Unknown IP')}</span>
              </div>
              <div class="text-sm text-gray-900 mb-2">${escapeHtml(s.message || '')}</div>
              ${s.stack ? `<details class="text-xs"><summary class="text-blue-600 cursor-pointer">Stack trace</summary><pre class="mt-2 p-2 bg-gray-50 rounded overflow-x-auto text-gray-700">${escapeHtml(s.stack)}</pre></details>` : ''}
              ${s.request?.path ? `<div class="text-xs text-gray-500 mt-2">${escapeHtml(s.request.method || 'GET')} ${escapeHtml(s.request.path)} ${s.request.statusCode ? '→ ' + s.request.statusCode : ''}</div>` : ''}
            </div>
          `).join('')}
        </div>
      `;

      document.getElementById('modal').classList.remove('hidden');
      document.getElementById('modal').classList.add('flex');
    }

    async function updateStatus(id, status) {
      try {
        const res = await fetch(`${API_BASE}/api/admin/errors/${id}/status`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status }),
        });
        if (!res.ok) return;
        const err = await res.json();
        renderModal(err);
        await loadErrors();
        await loadStats();
      } catch (e) {
        alert('Failed to update status');
      }
    }

    function closeModal() {
      document.getElementById('modal').classList.add('hidden');
      document.getElementById('modal').classList.remove('flex');
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str || '';
      return div.innerHTML;
    }

    function formatDate(dateStr) {
      if (!dateStr) return '—';
      const d = new Date(dateStr);
      return d.toLocaleString();
    }

    function refreshAll() {
      loadStats();
      loadErrors();
    }

    document.getElementById('btn-filter').addEventListener('click', () => { currentPage = 1; loadErrors(); });
    document.getElementById('filter-search').addEventListener('keypress', (e) => { if (e.key === 'Enter') { currentPage = 1; loadErrors(); } });
    document.getElementById('btn-prev').addEventListener('click', () => { if (currentPage > 1) { currentPage--; loadErrors(); } });
    document.getElementById('btn-next').addEventListener('click', () => { if (currentPage < totalPages) { currentPage++; loadErrors(); } });
    document.getElementById('modal-close').addEventListener('click', closeModal);
    document.getElementById('modal').addEventListener('click', (e) => { if (e.target.id === 'modal') closeModal(); });

    refreshAll();
  </script>
</body>
</html>
